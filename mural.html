<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>El Mural del Momento</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      background: #e9e4e0; /* m√°s suave y c√°lido */
      color: #222; /* mejor contraste */

    }

    header {
      padding: 2rem 1rem 1rem;
      background: linear-gradient(to right, #ff9a9e, #fad0c4);
      text-align: center;
    }

    header h1 {
      margin: 0;
      font-size: 2rem;
    }

    header p {
      font-size: 1rem;
      margin-top: 0.5rem;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
    }

    .formulario {
      padding: 1rem;
      background-color: #fff3e6;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      max-width: 500px;
      margin: 2rem auto;
      border-radius: 1rem;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
    }

    .formulario input,
    .formulario textarea,
    .formulario select,
    .formulario button {
      padding: 0.75rem;
      border-radius: 0.5rem;
      border: none;
      font-size: 1rem;
    }

    .formulario button {
      background-color: #ff9a9e;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }

    .formulario .doodle-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
    }

    .preview {
      display: none;
      text-align: center;
    }

    .preview img {
      max-width: 100%;
      max-height: 400px;
      margin-top: 1rem;
      border-radius: 0.5rem;
    }

    #canvasDoodle {
      display: none;
      border: 2px dashed #ff9a9e;
      border-radius: 0.5rem;
      background-color: white;
      touch-action: none;
    }

    .mural {
      position: relative;
      padding: 2rem;
      width: 100%;
      height: 100vh;
      background: #f2eee9;
      overflow: hidden;
    }

    .mural-item {
      position: absolute;
      padding: 1rem;
      border-radius: 1rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      max-width: 200px;
      text-align: center;
      word-break: break-word;
      background: rgba(255, 251, 224, 0.95);
      transform: rotate(var(--rot)) scale(var(--scale));
      opacity: 0.95;
      transition: transform 0.3s ease;
    }

    .mural-item.frase {
      font-size: 1.1rem;
      font-style: italic;
      color: #5a3e36;
    }

    .mural-item.emoji {
      font-size: 2.5rem;
      background: none;
      box-shadow: none;
      padding: 0;
    }

    .mural-item img {
      max-width: 100%;
      border-radius: 0.5rem;
    }

    @media (max-width: 600px) {
      .formulario {
        margin: 1rem;
      }
    }

    #muralContainer {
  position: relative;
  overflow: hidden;
  width: 100%;
  height: 100vh;
  background: #f2eee9;
  cursor: grab;
}

#mural {
  position: absolute;
  top: 0;
  left: 0;
  transform-origin: top left;
  transition: transform 0.2s ease;
  width: 3000px;
  height: 3000px;
}
  </style>
</head>
<body>
  <header>
    <h1>üß± El Mural del Momento</h1>
    <p>
      Un lienzo ef√≠mero donde puedes dejar tu huella emocional del d√≠a:
      im√°genes, emojis, frases o dibujos. Lo que compartas aqu√≠ desaparece a medianoche.
    </p>
  </header>

  <section class="formulario">
    <label>¬øQu√© quieres dejar hoy?</label>
    <select id="tipo">
      <option value="frase">‚úçÔ∏è Frase corta</option>
      <option value="emoji">üòÑ Emoji gigante</option>
      <option value="imagen">üñºÔ∏è Imagen (m√°x. 400x400px)</option>
      <option value="doodle">üé® Doodle r√°pido</option>
    </select>

    <input type="text" id="contenido" placeholder="Escribe algo..." />
    <input type="file" id="imagenInput" accept="image/*" style="display:none;" />
    <div class="doodle-controls" id="doodleControls" style="display:none;">
      <label>Color:</label>
      <input type="color" id="colorPicker" value="#222222">
      <button type="button" onclick="limpiarCanvas()">üßº Borrar doodle</button>
    </div>
    <canvas id="canvasDoodle" width="300" height="300"></canvas>

    <div class="preview" id="preview">
      <strong>Vista previa:</strong>
      <img id="previewImg" src="" alt="Previsualizaci√≥n" />
    </div>

    <button onclick="agregarAlMural()">Compartir en el Mural</button>
  </section>

<!-- Controles de zoom -->
<div id="zoomControls">
  <button id="zoomIn">+</button>
  <button id="zoomOut">‚Äì</button>
</div>

<!-- Contenedor del mural para pan/zoom -->
<div id="muralContainer">
  <section id="mural" class="mural"></section>
</div>

  
  <script>
    // üîê Obtener usuario desde localStorage
    const usuario = localStorage.getItem('usuarioMomento') || null;
    if (!usuario) alert('Debes iniciar sesi√≥n para usar el mural.');

    // üïõ Borrar mural si es un nuevo d√≠a
    const hoy = new Date().toDateString();
    const ultimaVisita = localStorage.getItem('muralFecha');
    if (ultimaVisita !== hoy) {
      localStorage.setItem('muralFecha', hoy);
      document.getElementById('mural').innerHTML = '';
    }

    const tipo = document.getElementById('tipo');
    const contenido = document.getElementById('contenido');
    const imagenInput = document.getElementById('imagenInput');
    const mural = document.getElementById('mural');
    const preview = document.getElementById('preview');
    const previewImg = document.getElementById('previewImg');
    const canvas = document.getElementById('canvasDoodle');
    const ctx = canvas.getContext('2d');
    const colorPicker = document.getElementById('colorPicker');
    const doodleControls = document.getElementById('doodleControls');

    let scale = 1, posX = 0, posY = 0;
  let isDragging = false, startX, startY;

  const muralContainer = document.getElementById('muralContainer');
  const zoomInBtn = document.getElementById('zoomIn');
  const zoomOutBtn = document.getElementById('zoomOut');

  function updateTransform() {
    mural.style.transform = `translate(${posX}px, ${posY}px) scale(${scale})`;
  }

  zoomInBtn.addEventListener('click', () => {
    scale = Math.min(2, scale + 0.1);
    updateTransform();
  });

  zoomOutBtn.addEventListener('click', () => {
    scale = Math.max(0.4, scale - 0.1);
    updateTransform();
  });

  muralContainer.addEventListener('mousedown', e => {
    isDragging = true;
    startX = e.clientX - posX;
    startY = e.clientY - posY;
    muralContainer.style.cursor = 'grabbing';
  });

  muralContainer.addEventListener('mousemove', e => {
    if (!isDragging) return;
    posX = e.clientX - startX;
    posY = e.clientY - startY;
    updateTransform();
  });

  muralContainer.addEventListener('mouseup', () => {
    isDragging = false;
    muralContainer.style.cursor = 'grab';
  });

  muralContainer.addEventListener('mouseleave', () => {
    isDragging = false;
    muralContainer.style.cursor = 'grab';
  });

    let drawing = false;

    tipo.addEventListener('change', () => {
      const tipoVal = tipo.value;
      contenido.style.display = tipoVal === 'imagen' || tipoVal === 'doodle' ? 'none' : 'block';
      imagenInput.style.display = tipoVal === 'imagen' ? 'block' : 'none';
      canvas.style.display = tipoVal === 'doodle' ? 'block' : 'none';
      doodleControls.style.display = tipoVal === 'doodle' ? 'flex' : 'none';
      preview.style.display = tipoVal === 'imagen' ? 'block' : 'none';
    });

    imagenInput.addEventListener('change', () => {
      const archivo = imagenInput.files[0];
      if (!archivo) return;
      const img = new Image();
      const reader = new FileReader();
      reader.onload = function(e) {
        img.onload = function() {
          if (img.width > 400 || img.height > 400) {
            alert('La imagen supera los 400x400px. Por favor, s√∫bela m√°s peque√±a.');
            imagenInput.value = '';
            previewImg.src = '';
            return;
          }
          previewImg.src = e.target.result;
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(archivo);
    });

    canvas.addEventListener('mousedown', () => drawing = true);
    canvas.addEventListener('mouseup', () => drawing = false);
    canvas.addEventListener('mouseleave', () => drawing = false);
    canvas.addEventListener('mousemove', e => {
      if (!drawing) return;
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      ctx.fillStyle = colorPicker.value;
      ctx.beginPath();
      ctx.arc(x, y, 2, 0, Math.PI * 2);
      ctx.fill();
    });

    function limpiarCanvas() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    async function agregarAlMural() {
  const tipoSeleccionado = tipo.value;
  const usuario = localStorage.getItem('usuarioMomento');
  let contenidoFinal = '';

  if (!usuario) {
    alert('Debes iniciar sesi√≥n para aportar al Mural');
    return;
  }

  if (tipoSeleccionado === 'frase' || tipoSeleccionado === 'emoji') {
    if (!contenido.value.trim()) {
      return alert('Escribe algo primero.');
    }
    contenidoFinal = contenido.value.trim();
    contenido.value = '';
  }

  else if (tipoSeleccionado === 'imagen') {
  const archivo = imagenInput.files[0];
  if (!archivo) return alert('Selecciona una imagen.');

  const formData = new FormData();
  formData.append('imagen', archivo);
  formData.append('usuario', usuario);

  try {
    const res = await fetch('https://momento-backend-production.up.railway.app/api/mural/image', {
      method: 'POST',
      body: formData
    });

    const data = await res.json();

    if (!res.ok) {
      throw new Error(data.message || 'Error subiendo imagen.');
    }

    mostrarAporte(data.data);
    imagenInput.value = '';
    previewImg.src = '';
    preview.style.display = 'none';

  } catch (err) {
    console.error('Error al subir imagen:', err);
    alert('La imagen fue rechazada o hubo un error.');
  }

  return;
}


  else if (tipoSeleccionado === 'doodle') {
    contenidoFinal = canvas.toDataURL();
    limpiarCanvas();
  }

  await enviarAlBackend(usuario, tipoSeleccionado, contenidoFinal);
}

  async function enviarAlBackend(usuario, tipo, contenido) {
  try {
    const res = await fetch('https://momento-backend-production.up.railway.app/api/mural', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ usuario, tipo, contenido })
    });

    if (!res.ok) throw new Error('No se pudo guardar el aporte');

    const data = await res.json();
    mostrarAporte(data.data); // Mostrar el aporte reci√©n guardado
  } catch (err) {
    console.error('Error guardando en el mural:', err);
    alert('Ocurri√≥ un error al guardar tu aporte.');
  }
}

function mostrarAporte({ tipo, contenido, usuario }) {
  const nuevo = document.createElement('div');
  nuevo.classList.add('mural-item');
  const { offsetWidth: w, offsetHeight: h } = mural;
  const x = Math.floor(Math.random() * (w - 200));
  const y = Math.floor(Math.random() * (h - 200));
  const rot = `${Math.floor(Math.random() * 10 - 5)}deg`;
  const scale = `${0.95 + Math.random() * 0.1}`;
  nuevo.style.left = `${x}px`;
  nuevo.style.top = `${y}px`;
  nuevo.style.setProperty('--rot', rot);
  nuevo.style.setProperty('--scale', scale);
  nuevo.title = `Aporte de: ${usuario}`;

  if (tipo === 'frase') {
    nuevo.classList.add('frase');
    nuevo.textContent = contenido;
  } else if (tipo === 'emoji') {
    nuevo.classList.add('emoji');
    nuevo.textContent = contenido;
  } else if (tipo === 'imagen' || tipo === 'doodle') {
    const img = new Image();
    img.src = contenido;
    img.onload = () => mural.appendChild(nuevo);
    nuevo.appendChild(img);
  }

  mural.appendChild(nuevo);
}

cargarAportes();

async function cargarAportes() {
  try {
    const res = await fetch('https://momento-backend-production.up.railway.app/api/mural/today');
    const datos = await res.json();
    datos.forEach(aporte => mostrarAporte(aporte));
  } catch (err) {
    console.error('Error al cargar el mural:', err);
  }
}

    
  </script>
</body>
</html>
