<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>El Mural del Momento</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/estilos-mural.css" />
</head>
<body>

  <!-- Modal inicial -->
  <div id="modalOverlay">
    <div id="mensajeInicial" class="modal">
      <p>üß± El Mural del Momento es un lienzo ef√≠mero donde puedes dejar tu huella emocional del d√≠a: frases, emojis, im√°genes o dibujos. Todo desaparece a medianoche.</p>
      <label><input type="checkbox" id="noMostrarCheckbox"> No volver a mostrar</label>
      <br/>
      <button id="btnCerrarModal">Cerrar</button>
    </div>
  </div>

  <!-- Formulario flotante -->
  <section class="formulario flotante" id="formularioPrincipal">
    <label>¬øQu√© quieres dejar hoy?</label>
    <select id="tipo">
      <option value="frase">‚úçÔ∏è Frase corta</option>
      <option value="emoji">üòÑ Emoji gigante</option>
      <option value="imagen">üñºÔ∏è Imagen (m√°x. 400x400px)</option>
      <option value="doodle">üé® Doodle r√°pido</option>
    </select>
    <input type="text" id="contenido" placeholder="Escribe algo..." />
    <input type="file" id="imagenInput" accept="image/*" style="display:none;" />
    <div class="doodle-controls" id="doodleControls" style="display:none;">
      <label>Color:</label>
      <input type="color" id="colorPicker" value="#222222">
      <button type="button" id="btnLimpiarDoodle">üßº Borrar doodle</button>
    </div>
    <canvas id="canvasDoodle" width="300" height="300"></canvas>
    <div class="preview" id="preview" style="display:none;">
      <strong>Vista previa:</strong>
      <img id="previewImg" src="" alt="Previsualizaci√≥n" />
    </div>
    <button id="btnCompartir">Compartir en el Mural</button>
  </section>

  <!-- Panel ‚ÄúMis Aportes‚Äù -->
  <div id="misAportes">
    <h3>Mis Aportes</h3>
    <div id="listaMisAportes"></div>
  </div>

  <!-- Contenedor del mural -->
  <div id="muralContainer">
    <div id="mural" class="mural-contenedor"></div>
  </div>

  <!-- Footer con acciones y zoom -->
  <div class="footer-controles">
    <button id="btnMostrarFormulario">‚úö Aportar</button>
    <button id="btnMostrarAportes">üìÅ Aportes</button>
    <button id="zoomIn">üîç +</button>
    <button id="zoomOut">üîç ‚Äì</button>
  </div>

   <script>
// Variables globales de transformaci√≥n
let scale = 1;
let position = { x: 0, y: 0 };
let isDragging = false;
let startDrag = { x: 0, y: 0 };

const muralContainer = document.getElementById("muralContainer");
const mural = document.getElementById("mural");

function aplicarTransformaciones() {
  mural.style.transform = `translate(${position.x}px, ${position.y}px) scale(${scale})`;
}

// Zoom con scroll
muralContainer.addEventListener("wheel", (e) => {
  e.preventDefault();
  const delta = -e.deltaY;
  const zoomFactor = 0.1;
  if (delta > 0) {
    scale = Math.min(scale + zoomFactor, 3); // Zoom m√°ximo 3x
  } else {
    scale = Math.max(scale - zoomFactor, 0.5); // Zoom m√≠nimo 0.5x
  }
  aplicarTransformaciones();
});

// Arrastrar con mouse
muralContainer.addEventListener("mousedown", (e) => {
  isDragging = true;
  startDrag = { x: e.clientX - position.x, y: e.clientY - position.y };
});

document.addEventListener("mousemove", (e) => {
  if (!isDragging) return;
  position.x = e.clientX - startDrag.x;
  position.y = e.clientY - startDrag.y;
  aplicarTransformaciones();
});

document.addEventListener("mouseup", () => {
  isDragging = false;
});

// Compatibilidad t√°ctil
let lastTouchDistance = null;

muralContainer.addEventListener("touchstart", (e) => {
  if (e.touches.length === 1) {
    isDragging = true;
    startDrag = {
      x: e.touches[0].clientX - position.x,
      y: e.touches[0].clientY - position.y,
    };
  } else if (e.touches.length === 2) {
    isDragging = false;
    lastTouchDistance = getTouchDistance(e.touches);
  }
});

muralContainer.addEventListener("touchmove", (e) => {
  e.preventDefault();
  if (isDragging && e.touches.length === 1) {
    position.x = e.touches[0].clientX - startDrag.x;
    position.y = e.touches[0].clientY - startDrag.y;
    aplicarTransformaciones();
  } else if (e.touches.length === 2) {
    const currentDistance = getTouchDistance(e.touches);
    const zoomFactor = 0.005;
    const delta = currentDistance - lastTouchDistance;
    scale = Math.min(Math.max(scale + delta * zoomFactor, 0.5), 3);
    lastTouchDistance = currentDistance;
    aplicarTransformaciones();
  }
}, { passive: false });

muralContainer.addEventListener("touchend", () => {
  isDragging = false;
  lastTouchDistance = null;
});

// Ayudante para calcular distancia entre dedos
function getTouchDistance(touches) {
  const dx = touches[0].clientX - touches[1].clientX;
  const dy = touches[0].clientY - touches[1].clientY;
  return Math.sqrt(dx * dx + dy * dy);
}

// Botones de zoom manual
document.getElementById("zoomIn").addEventListener("click", () => {
  scale = Math.min(scale + 0.1, 3);
  aplicarTransformaciones();
});

document.getElementById("zoomOut").addEventListener("click", () => {
  scale = Math.max(scale - 0.1, 0.5);
  aplicarTransformaciones();
});


     
  // Array global para llevar registro de los aportes cargados
  let ultimosAportes = [];

  document.addEventListener('DOMContentLoaded', () => {
    if (!verificarToken()) return;

    usuario = obtenerUsuarioDesdeToken();
    console.log('üë§ Usuario cargado desde token:', usuario);

    // Referencias DOM
    const mural = document.getElementById("mural");
    const formulario = document.getElementById("formularioPrincipal");
    const misAportes = document.getElementById("misAportes");
    const btnFormulario = document.getElementById("btnMostrarFormulario");
    const btnAportes = document.getElementById("btnMostrarAportes");
    const zoomInBtn = document.getElementById("zoomIn");
    const zoomOutBtn = document.getElementById("zoomOut");
    const btnCompartir = document.getElementById("btnCompartir");
    const btnCerrarModal = document.getElementById("btnCerrarModal");
    const modalOverlay = document.getElementById("modalOverlay");

    // Cerrar modal inicial
    if (btnCerrarModal && modalOverlay) {
      btnCerrarModal.addEventListener('click', () => {
        if (document.getElementById('noMostrarCheckbox').checked) {
          localStorage.setItem('noMostrarMensajeMural', 'true');
        }
        modalOverlay.style.display = 'none';
      });
    }

    // Validaci√≥n m√≠nima
    if (!mural || !formulario || !misAportes || !btnFormulario || !btnAportes || !zoomInBtn || !zoomOutBtn || !btnCompartir) {
      console.error("‚ùå Faltan elementos del DOM requeridos.");
      return;
    }

    // Toggle formulario / mis aportes
    btnFormulario.addEventListener("click", () => {
      const vis = formulario.classList.toggle("mostrar");
      btnFormulario.textContent = vis ? "‚úñ Cerrar" : "‚úö Aportar";
      if (vis) misAportes.classList.remove("mostrar");
    });
    btnAportes.addEventListener("click", () => {
      const vis = misAportes.classList.toggle("mostrar");
      btnAportes.textContent = vis ? "‚úñ Cerrar" : "üìÅ Aportes";
      if (vis) formulario.classList.remove("mostrar");
    });

  

    // Compartir aporte
    btnCompartir.addEventListener("click", agregarAlMural);

    // Mostrar modal si no marcamos "no mostrar"
    if (!localStorage.getItem('noMostrarMensajeMural')) {
      modalOverlay.style.display = 'flex';
    }

    // Carga inicial
    cargarAportes();
  });

  // Decodifica usuario del JWT
  function obtenerUsuarioDesdeToken() {
    const t = localStorage.getItem('token');
    if (!t) return null;
    try {
      const p = JSON.parse(atob(t.split('.')[1]));
      return p.username;
    } catch {
      return null;
    }
  }

  // Verifica que haya token
  function verificarToken() {
    if (!localStorage.getItem('token')) {
      alert('Debes iniciar sesi√≥n para usar el mural.');
      window.location.href = '/index.html';
      return false;
    }
    return true;
  }

  // Agrega un aporte: imagem, frase, emoji o doodle
  async function agregarAlMural() {
    const tipo = document.getElementById('tipo').value;
    const contenidoEl = document.getElementById('contenido');
    const imagenInput = document.getElementById('imagenInput');
    const canvas = document.getElementById('canvasDoodle');

    let contenidoFinal = '';
    if (tipo === 'frase' || tipo === 'emoji') {
      if (!contenidoEl.value.trim()) return alert('Escribe algo primero.');
      contenidoFinal = contenidoEl.value.trim();
      contenidoEl.value = '';
    }
    else if (tipo === 'imagen') {
      const file = imagenInput.files[0];
      if (!file) return alert('Selecciona una imagen.');
      // sube primero la imagen al endpoint /image
      const fd = new FormData();
      fd.append('imagen', file);
      fd.append('usuario', usuario);
      try {
        const resImg = await fetch('https://momento-backend-production.up.railway.app/api/mural/image', {
          method: 'POST', body: fd
        });
        const jsonImg = await resImg.json();
        if (!resImg.ok) throw new Error(jsonImg.message);
        contenidoFinal = jsonImg.data.contenido;  // URL de la imagen
        imagenInput.value = '';
        document.getElementById('preview').style.display = 'none';
      } catch (e) {
        return alert('Error subiendo imagen: ' + e.message);
      }
    }
    else if (tipo === 'doodle') {
      contenidoFinal = document.getElementById('canvasDoodle').toDataURL();
      limpiarCanvas();
    }

    // Finalmente, env√≠a el aporte
    await enviarAlBackend({
  usuario,
  tipo,
  contenido: contenidoFinal
});

  }

  // Limpia el canvas
  function limpiarCanvas() {
    const c = document.getElementById('canvasDoodle');
    c.getContext('2d').clearRect(0, 0, c.width, c.height);
  }

  // Envia al backend y actualiza mural + ‚Äúmis aportes‚Äù
  async function enviarAlBackend(data) {
  const token = localStorage.getItem("token"); // Aseg√∫rate de que est√© guardado correctamente

  try {
    const res = await fetch("https://momento-backend-production.up.railway.app/api/mural", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}`, // üëà Agregado correctamente
      },
      body: JSON.stringify(data),
    });

    if (!res.ok) {
      throw new Error("Error al enviar el aporte");
    }

    return await res.json();
  } catch (error) {
    console.error("Error", error);
    throw error;
  }
}

  // Renderiza un aporte suelto en el mural
  function mostrarAporte({ _id, tipo, contenido, usuario }) {
    const mural = document.getElementById('mural');
    const div = document.createElement('div');
    div.className = 'mural-item ' + tipo;
    div.id = `aporte-${_id}`;
    // posici√≥n aleatoria dentro de mural
    const { offsetWidth: w, offsetHeight: h } = mural;
    const x = Math.random() * (w - 200), y = Math.random() * (h - 200);
    div.style.left = `${x}px`;
    div.style.top = `${y}px`;
    if (tipo === 'imagen' || tipo === 'doodle') {
      const img = new Image();
      img.src = contenido;
      div.appendChild(img);
    } else {
      div.textContent = contenido;
    }
    div.title = `Por ${usuario}`;
    mural.appendChild(div);
  }

  // Carga y muestra todas las aportes del d√≠a
  async function cargarAportes() {
    try {
      const res = await fetch('https://momento-backend-production.up.railway.app/api/mural/today');
      const datos = await res.json();
      ultimosAportes = datos;
      // muestra en mural y en ‚Äúmis aportes‚Äù
      datos.forEach(mostrarAporte);
      mostrarMisAportes(datos);
    } catch (e) {
      console.error('Error al cargar el mural:', e);
    }
  }

  // Muestra la lista ‚ÄúMis Aportes‚Äù
  function mostrarMisAportes(datos) {
  const cont = document.getElementById('listaMisAportes');
  cont.innerHTML = '';
  const ahora = Date.now();

  datos
    .filter(a => a.usuario === usuario)
    .forEach(a => {
      const div = document.createElement('div');
      div.className = 'aporte-propio';
      div.textContent = `‚Ä¢ ${a.tipo}`;

      // Tiempo restante antes de que expire
      const creado = new Date(a.fechaCreacion).getTime();
      const restanteMin = Math.max(0, Math.floor((creado + 6 * 3600 * 1000 - ahora) / 60000));
      const span = document.createElement('span');
      span.className = 'tiempo-restante';
      span.textContent = ` ‚è≥ ${restanteMin}min`;

      // Bot√≥n eliminar
      const btnEliminar = document.createElement('button');
      btnEliminar.textContent = 'üóëÔ∏è';
      btnEliminar.className = 'btn-eliminar';
      btnEliminar.onclick = () => eliminarAporte(a._id);

      div.appendChild(span);
      div.appendChild(btnEliminar);
      cont.appendChild(div);
    });
}

async function eliminarAporte(id) {
  const token = localStorage.getItem('token');
  if (!token) return alert('Token no encontrado');

  if (!confirm('¬øSeguro que quieres eliminar este aporte?')) return;

  try {
    const res = await fetch(`https://momento-backend-production.up.railway.app/api/mural/${id}`, {
      method: 'DELETE',
      headers: {
        Authorization: `Bearer ${token}`,
      },
    });

    if (!res.ok) throw new Error('No se pudo eliminar el aporte');

    // Elimina del DOM
    const elem = document.getElementById(`aporte-${id}`);
    if (elem) elem.remove();

    // Recarga ‚ÄúMis Aportes‚Äù
    ultimosAportes = ultimosAportes.filter(a => a._id !== id);
    mostrarMisAportes(ultimosAportes);

  } catch (err) {
    console.error('Error al eliminar el aporte:', err);
    alert('No se pudo eliminar el aporte.');
  }
}

     
</script>
</body>
</html>
