<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>El Mural del Momento</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body {
  margin: 0;
  font-family: 'Inter', sans-serif;
  background: #000; /* fondo negro */
  color: #fff; /* texto claro */
}


    header {
      padding: 2rem 1rem 1rem;
      background: linear-gradient(to right, #ff9a9e, #fad0c4);
      text-align: center;
    }

    header h1 {
      margin: 0;
      font-size: 2rem;
    }

    header p {
      font-size: 1rem;
      margin-top: 0.5rem;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
    }

    .formulario {
  position: fixed;
  top: 1rem;
  right: 1rem;
  padding: 1rem;
  background-color: #1a1a1a;
  display: flex;
  flex-direction: column;
  gap: 1rem;
  max-width: 320px;
  z-index: 9999;
  border-radius: 1rem;
  box-shadow: 0 0 10px rgba(255, 255, 255, 0.1);
  color: #f1f1f1;
}


    .formulario input,
.formulario textarea,
.formulario select {
  padding: 0.75rem;
  border-radius: 0.5rem;
  border: none;
  font-size: 1rem;
  background-color: #2c2c2c;
  color: #f1f1f1;
}

.formulario button {
  background-color: #4f46e5;
  color: white;
  font-weight: bold;
  cursor: pointer;
  border-radius: 0.5rem;
  font-size: 1rem;
  padding: 0.75rem;
}


    .formulario .doodle-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
    }

    .preview {
      display: none;
      text-align: center;
    }

    .preview img {
      max-width: 100%;
      max-height: 400px;
      margin-top: 1rem;
      border-radius: 0.5rem;
    }

    #canvasDoodle {
  display: none;
  border: 2px dashed #ff9a9e;
  border-radius: 0.5rem;
  background-color: #111;
  touch-action: none;
}


    .mural {
  position: relative;
  padding: 2rem;
  width: 100%;
  height: 100vh;
  background: #000; /* fondo negro completo */
  overflow: hidden;
}


    .mural-item {
  position: absolute;
  padding: 1rem;
  border-radius: 1rem;
  border: 1px solid rgba(255, 255, 255, 0.2); /* borde blanco sutil */
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
  max-width: 200px;
  text-align: center;
  word-break: break-word;
  background: rgba(255, 251, 224, 0.95);
  transform: rotate(var(--rot)) scale(var(--scale));
  opacity: 0.95;
  transition: transform 0.3s ease;
}

    .mural-item.frase {
      font-size: 1.1rem;
      font-style: italic;
      color: #5a3e36;
    }

    .mural-item.emoji {
      font-size: 2.5rem;
      background: none;
      box-shadow: none;
      padding: 0;
    }

    .mural-item img {
      max-width: 100%;
      border-radius: 0.5rem;
    }

    @media (max-width: 600px) {
      .formulario {
        margin: 1rem;
      }
    }

    #muralContainer {
  position: relative;
  overflow: hidden;
  width: 100%;
  height: 100vh;
  background: #000; /* fondo negro */
  cursor: grab;
}


#mural {
  position: absolute;
  top: 0;
  left: 0;
  transform-origin: top left;
  transition: transform 0.2s ease;
  width: 3000px;
  height: 3000px;
}

.formulario.flotante {
  position: fixed;
  top: 1rem;
  right: 1rem;
  z-index: 9999;
  margin: 0;
}

/* Panel flotante para aportes del usuario */
#misAportes {
  position: fixed;
  bottom: 1rem;
  right: 1rem;
  max-height: 300px;
  width: 250px;
  overflow-y: auto;
  background: rgba(255, 255, 255, 0.1);
  backdrop-filter: blur(6px);
  border-radius: 1rem;
  padding: 1rem;
  color: #fff;
  font-size: 0.9rem;
  z-index: 9999;
}

#misAportes h3 {
  margin-top: 0;
  font-size: 1rem;
  color: #ff9a9e;
}

.aporte-propio {
  margin-bottom: 0.5rem;
  padding: 0.5rem;
  background: rgba(255,255,255,0.05);
  border-radius: 0.5rem;
  position: relative;
}

.aporte-propio:hover .tiempo-restante {
  display: block;
}

.borrar-aporte {
  position: absolute;
  top: 4px;
  right: 8px;
  background: transparent;
  border: none;
  color: #ff6666;
  font-weight: bold;
  cursor: pointer;
}

.tiempo-restante {
  display: none;
  font-size: 0.75rem;
  color: #ccc;
  margin-top: 0.3rem;
}

.aporte-usuario button {
  margin-top: 0.5rem;
  background: #ff5c5c;
  color: white;
  border: none;
  padding: 0.3rem 0.6rem;
  font-size: 0.8rem;
  border-radius: 0.4rem;
  cursor: pointer;
}

      
  </style>
</head>
<body>
  <div id="mensajeInicial" style="position: fixed; top: 0; left: 0; right: 0; background: #222; color: #fff; padding: 1rem; text-align: center; z-index: 10000; display: none;">
  <p>üß± El Mural del Momento es un lienzo ef√≠mero donde puedes dejar tu huella emocional del d√≠a: frases, emojis, im√°genes o dibujos. Todo desaparece a medianoche.</p>
  <label><input type="checkbox" id="noMostrarCheckbox"> No volver a mostrar</label>
  <button onclick="cerrarMensaje()">Cerrar</button>
</div>


  <section class="formulario flotante">
    <label>¬øQu√© quieres dejar hoy?</label>
    <select id="tipo">
      <option value="frase">‚úçÔ∏è Frase corta</option>
      <option value="emoji">üòÑ Emoji gigante</option>
      <option value="imagen">üñºÔ∏è Imagen (m√°x. 400x400px)</option>
      <option value="doodle">üé® Doodle r√°pido</option>
    </select>

    <input type="text" id="contenido" placeholder="Escribe algo..." />
    <input type="file" id="imagenInput" accept="image/*" style="display:none;" />
    <div class="doodle-controls" id="doodleControls" style="display:none;">
      <label>Color:</label>
      <input type="color" id="colorPicker" value="#222222">
      <button type="button" onclick="limpiarCanvas()">üßº Borrar doodle</button>
    </div>
    <canvas id="canvasDoodle" width="300" height="300"></canvas>

    <div class="preview" id="preview">
      <strong>Vista previa:</strong>
      <img id="previewImg" src="" alt="Previsualizaci√≥n" />
    </div>

    <button onclick="agregarAlMural()">Compartir en el Mural</button>
  </section>

<!-- Controles de zoom -->
<div id="zoomControls">
  <button id="zoomIn">+</button>
  <button id="zoomOut">‚Äì</button>
</div>

<!-- Contenedor del mural para pan/zoom -->
<div id="muralContainer">
  <section id="mural" class="mural"></section>
</div>

  <!-- Panel flotante con aportes del usuario -->
<div id="misAportes">
  <h3>Mis Aportes</h3>
  <div id="listaMisAportes"></div>
</div>

  <script>
    function verificarToken() {
  const token = localStorage.getItem('token');
  if (!token) {
    alert('Debes iniciar sesi√≥n para usar el mural.');
    window.location.href = '/index.html'; // o a donde tengas el login
    return false;
  }
  return true;
}

window.addEventListener('DOMContentLoaded', () => {
  if (!verificarToken()) return;

  // aqu√≠ puedes llamar a funciones como cargarAportes()
  cargarAportes();
});


    // üïõ Borrar mural si es un nuevo d√≠a
    const hoy = new Date().toDateString();
    const ultimaVisita = localStorage.getItem('muralFecha');
    if (ultimaVisita !== hoy) {
      localStorage.setItem('muralFecha', hoy);
      document.getElementById('mural').innerHTML = '';
    }

    const tipo = document.getElementById('tipo');
    const contenido = document.getElementById('contenido');
    const imagenInput = document.getElementById('imagenInput');
    const mural = document.getElementById('mural');
    const preview = document.getElementById('preview');
    const previewImg = document.getElementById('previewImg');
    const canvas = document.getElementById('canvasDoodle');
    const ctx = canvas.getContext('2d');
    const colorPicker = document.getElementById('colorPicker');
    const doodleControls = document.getElementById('doodleControls');

    let scale = 1, posX = 0, posY = 0;
  let isDragging = false, startX, startY;

  const muralContainer = document.getElementById('muralContainer');
  const zoomInBtn = document.getElementById('zoomIn');
  const zoomOutBtn = document.getElementById('zoomOut');

  function updateTransform() {
    mural.style.transform = `translate(${posX}px, ${posY}px) scale(${scale})`;
  }

  zoomInBtn.addEventListener('click', () => {
    scale = Math.min(2, scale + 0.1);
    updateTransform();
  });

  zoomOutBtn.addEventListener('click', () => {
    scale = Math.max(0.4, scale - 0.1);
    updateTransform();
  });

  muralContainer.addEventListener('mousedown', e => {
    isDragging = true;
    startX = e.clientX - posX;
    startY = e.clientY - posY;
    muralContainer.style.cursor = 'grabbing';
  });

  muralContainer.addEventListener('mousemove', e => {
    if (!isDragging) return;
    posX = e.clientX - startX;
    posY = e.clientY - startY;
    updateTransform();
  });

  muralContainer.addEventListener('mouseup', () => {
    isDragging = false;
    muralContainer.style.cursor = 'grab';
  });

  muralContainer.addEventListener('mouseleave', () => {
    isDragging = false;
    muralContainer.style.cursor = 'grab';
  });

    let drawing = false;

    tipo.addEventListener('change', () => {
      const tipoVal = tipo.value;
      contenido.style.display = tipoVal === 'imagen' || tipoVal === 'doodle' ? 'none' : 'block';
      imagenInput.style.display = tipoVal === 'imagen' ? 'block' : 'none';
      canvas.style.display = tipoVal === 'doodle' ? 'block' : 'none';
      doodleControls.style.display = tipoVal === 'doodle' ? 'flex' : 'none';
      preview.style.display = tipoVal === 'imagen' ? 'block' : 'none';
    });

    imagenInput.addEventListener('change', () => {
      const archivo = imagenInput.files[0];
      if (!archivo) return;
      const img = new Image();
      const reader = new FileReader();
      reader.onload = function(e) {
        img.onload = function() {
          if (img.width > 400 || img.height > 400) {
            alert('La imagen supera los 400x400px. Por favor, s√∫bela m√°s peque√±a.');
            imagenInput.value = '';
            previewImg.src = '';
            return;
          }
          previewImg.src = e.target.result;
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(archivo);
    });

    canvas.addEventListener('mousedown', () => drawing = true);
    canvas.addEventListener('mouseup', () => drawing = false);
    canvas.addEventListener('mouseleave', () => drawing = false);
    canvas.addEventListener('mousemove', e => {
      if (!drawing) return;
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      ctx.fillStyle = colorPicker.value;
      ctx.beginPath();
      ctx.arc(x, y, 2, 0, Math.PI * 2);
      ctx.fill();
    });

    function limpiarCanvas() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    async function agregarAlMural() {
  const tipoSeleccionado = tipo.value;
  localStorage.getItem('token')
if (!token) {
  alert('Debes iniciar sesi√≥n para usar el mural.');
  throw new Error('Token no encontrado');
}

  let contenidoFinal = '';

 

  if (tipoSeleccionado === 'frase' || tipoSeleccionado === 'emoji') {
    if (!contenido.value.trim()) {
      return alert('Escribe algo primero.');
    }
    contenidoFinal = contenido.value.trim();
    contenido.value = '';
  }

  else if (tipoSeleccionado === 'imagen') {
  const archivo = imagenInput.files[0];
  if (!archivo) return alert('Selecciona una imagen.');

  const formData = new FormData();
  formData.append('imagen', archivo);
  formData.append('usuario', usuario);


  try {
    const res = await fetch('https://momento-backend-production.up.railway.app/api/mural/image', {
      method: 'POST',
      body: formData
    });

    const data = await res.json();

    if (!res.ok) {
      throw new Error(data.message || 'Error subiendo imagen.');
    }

    mostrarAporte(data.data);
    imagenInput.value = '';
    previewImg.src = '';
    preview.style.display = 'none';

  } catch (err) {
    console.error('Error al subir imagen:', err);
    alert('La imagen fue rechazada o hubo un error.');
  }

  return;
}


  else if (tipoSeleccionado === 'doodle') {
    contenidoFinal = canvas.toDataURL();
    limpiarCanvas();
  }

  await enviarAlBackend(usuario, tipoSeleccionado, contenidoFinal);
}

  async function enviarAlBackend(usuario, tipo, contenido) {
  localStorage.getItem('token')
  if (!token) return alert('No has iniciado sesi√≥n.');

  try {
    const res = await fetch('https://momento-backend-production.up.railway.app/api/mural', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        Authorization: `Bearer ${token}`
      },
      body: JSON.stringify({ tipo, contenido })
    });

    const data = await res.json();
    if (!res.ok) throw new Error(data.message || 'No se pudo guardar el aporte');

    mostrarAporte(data.data);
  } catch (err) {
    alert(err.message);
    console.error('Error guardando en el mural:', err);
  }
}


function mostrarAporte({ _id, tipo, contenido, usuario }) {
  const nuevo = document.createElement('div');
  nuevo.classList.add('mural-item');
  nuevo.id = `aporte-${_id}`; // ‚úÖ ‚Üê esta l√≠nea

  const { offsetWidth: w, offsetHeight: h } = mural;
  const x = Math.floor(Math.random() * (w - 200));
  const y = Math.floor(Math.random() * (h - 200));
  const rot = `${Math.floor(Math.random() * 10 - 5)}deg`;
  const scale = `${0.95 + Math.random() * 0.1}`;
  nuevo.style.left = `${x}px`;
  nuevo.style.top = `${y}px`;
  nuevo.style.setProperty('--rot', rot);
  nuevo.style.setProperty('--scale', scale);
  nuevo.title = `Aporte de: ${usuario}`;

  if (tipo === 'frase') {
    nuevo.classList.add('frase');
    nuevo.textContent = contenido;
  } else if (tipo === 'emoji') {
    nuevo.classList.add('emoji');
    nuevo.textContent = contenido;
  } else if (tipo === 'imagen' || tipo === 'doodle') {
    const img = new Image();
    img.src = contenido;
    img.onload = () => mural.appendChild(nuevo);
    nuevo.appendChild(img);
  }

  mural.appendChild(nuevo);
}


cargarAportes();

// Reemplazar esta parte en cargarAportes()
async function cargarAportes() {
  try {
    const res = await fetch('https://momento-backend-production.up.railway.app/api/mural/today');
    const datos = await res.json();
    datos.forEach(aporte => mostrarAporte(aporte));
    mostrarMisAportes(datos); // ‚Üê NUEVO
  } catch (err) {
    console.error('Error al cargar el mural:', err);
  }
}

// ü™ß Mostrar mensaje inicial si no ha sido ocultado permanentemente
window.addEventListener('DOMContentLoaded', () => {
  if (!localStorage.getItem('noMostrarMensajeMural')) {
    document.getElementById('mensajeInicial').style.display = 'block';
  }
});

function cerrarMensaje() {
  const noMostrar = document.getElementById('noMostrarCheckbox').checked;
  if (noMostrar) {
    localStorage.setItem('noMostrarMensajeMural', 'true');
  }
  document.getElementById('mensajeInicial').style.display = 'none';
}

// üß† Palabras prohibidas
const palabrasProhibidas = ['odio', 'muerte', 'est√∫pido', 'imb√©cil'];
const tiempoSuspension = 30 * 60 * 1000; // 30 minutos

function contienePalabraProhibida(texto) {
  const palabras = texto.toLowerCase().split(/\s+/);
  return palabrasProhibidas.some(prohibida => palabras.includes(prohibida));
}

function estaSuspendido() {
  const finSuspension = localStorage.getItem('momentoSuspension');
  return finSuspension && new Date().getTime() < parseInt(finSuspension);
}

// Mostrar aportes del usuario y sus tiempos restantes
function mostrarMisAportes(datos) {
  const contenedor = document.getElementById('listaMisAportes');
  contenedor.innerHTML = '';

  localStorage.getItem('token')
if (!token) {
  alert('Debes iniciar sesi√≥n para usar el mural.');
  throw new Error('Token no encontrado');
}

  const ahora = new Date();

  datos
    .filter(aporte => aporte.usuario === usuario)
    .forEach(aporte => {
      const div = document.createElement('div');
      div.className = 'aporte-propio';

      const span = document.createElement('span');
      span.textContent = `‚Ä¢ ${aporte.tipo}`;

      const tiempoRestante = document.createElement('div');
      tiempoRestante.className = 'tiempo-restante';
      const creado = new Date(aporte.fechaCreacion);
      const expiracion = new Date(creado.getTime() + 6 * 60 * 60 * 1000);
      const minutosRestantes = Math.floor((expiracion - ahora) / 60000);
      tiempoRestante.textContent = `‚è≥ ${minutosRestantes} min restantes`;

      const btnBorrar = document.createElement('button');
      btnBorrar.textContent = '‚úñ';
      btnBorrar.className = 'borrar-aporte';
      btnBorrar.onclick = async () => {
  if (!confirm('¬øEliminar este aporte?')) return;

  const res = await fetch(`https://momento-backend-production.up.railway.app/api/mural/${aporte._id}`, {
    method: 'DELETE',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ usuario })
  });

  const data = await res.json();

  if (!res.ok) {
    alert(data.message || 'Error al eliminar.');
    return;
  }

  div.remove();
};


      div.appendChild(span);
      div.appendChild(btnBorrar);
      div.appendChild(tiempoRestante);
      contenedor.appendChild(div);
    });
}

async function cargarMisAportes() {
  localStorage.getItem('token')
if (!token) {
  alert('Debes iniciar sesi√≥n para usar el mural.');
  throw new Error('Token no encontrado');
}

  const lista = document.getElementById('listaAportesUsuario');
  lista.innerHTML = '';

  try {
    const res = await fetch('https://momento-backend-production.up.railway.app/api/mural/today');
    const datos = await res.json();
    const mios = datos.filter(a => a.usuario === usuario);

    mios.forEach(aporte => {
      const div = document.createElement('div');
      div.classList.add('aporte-usuario');

      const tipo = aporte.tipo === 'emoji' ? 'Emoji' :
                   aporte.tipo === 'frase' ? 'Frase' :
                   aporte.tipo === 'imagen' ? 'Imagen' : 'Doodle';

      const creado = new Date(aporte.fechaCreacion);
      const restante = 86400 - Math.floor((Date.now() - creado.getTime()) / 1000);
      const minutosRestantes = Math.floor(restante / 60);

      div.innerHTML = `
        <strong>${tipo}</strong><br/>
        ${aporte.tipo === 'frase' || aporte.tipo === 'emoji' ? aporte.contenido : ''}
        <div class="tiempo-restante">‚è≥ Quedan ${minutosRestantes} min</div>
        <button onclick="borrarAporte('${aporte._id}')">üóë Eliminar</button>
      `;

      lista.appendChild(div);
    });

  } catch (err) {
    console.error('Error cargando aportes del usuario:', err);
  }
}

async function eliminarAporte(id, divElemento) {
  localStorage.getItem('token')
if (!token) {
  alert('Debes iniciar sesi√≥n para usar el mural.');
  throw new Error('Token no encontrado');
}


  const confirmacion = confirm('¬øEst√°s seguro de eliminar este aporte?');
  if (!confirmacion) return;

  try {
    const res = await fetch(`https://momento-backend-production.up.railway.app/api/mural/${id}`, {
      method: 'DELETE',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ usuario })
    });

    const data = await res.json();

    if (!res.ok) throw new Error(data.message || 'Error al eliminar');

    // Eliminar visualmente el aporte del DOM
    divElemento.remove();
  } catch (err) {
    alert(err.message);
    console.error(err);
  }
}




    
  </script>
</body>
</html>
