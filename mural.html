<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>El Mural del Momento</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/estilos-mural.css" />
</head>
<body>

  <!-- Modal inicial -->
  <div id="modalOverlay">
    <div id="mensajeInicial" class="modal">
      <p>🧱 El Mural del Momento es un lienzo efímero donde puedes dejar tu huella emocional del día: frases, emojis, imágenes o dibujos. Todo desaparece a medianoche.</p>
      <label><input type="checkbox" id="noMostrarCheckbox"> No volver a mostrar</label>
      <br/>
      <button id="btnCerrarModal">Cerrar</button>
    </div>
  </div>

  <!-- Formulario flotante -->
  <section class="formulario flotante" id="formularioPrincipal">
    <label>¿Qué quieres dejar hoy?</label>
    <select id="tipo">
      <option value="frase">✍️ Frase corta</option>
      <option value="emoji">😄 Emoji gigante</option>
      <option value="imagen">🖼️ Imagen (máx. 400x400px)</option>
      <option value="doodle">🎨 Doodle rápido</option>
    </select>
    <input type="text" id="contenido" placeholder="Escribe algo..." />
    <input type="file" id="imagenInput" accept="image/*" style="display:none;" />
    <div class="doodle-controls" id="doodleControls" style="display:none;">
      <label>Color:</label>
      <input type="color" id="colorPicker" value="#222222">
      <button type="button" id="btnLimpiarDoodle">🧼 Borrar doodle</button>
    </div>
    <canvas id="canvasDoodle" width="300" height="300"></canvas>
    <div class="preview" id="preview" style="display:none;">
      <strong>Vista previa:</strong>
      <img id="previewImg" src="" alt="Previsualización" />
    </div>
    <button id="btnCompartir">Compartir en el Mural</button>
  </section>

  <!-- Panel “Mis Aportes” -->
  <div id="misAportes">
    <h3>Mis Aportes</h3>
    <div id="listaMisAportes"></div>
  </div>

  <!-- Contenedor del mural -->
  <div id="muralContainer">
    <div id="mural" class="mural-contenedor"></div>
  </div>

  <!-- Footer con acciones y zoom -->
  <div class="footer-controles">
    <button id="btnMostrarFormulario">✚ Aportar</button>
    <button id="btnMostrarAportes">📁 Aportes</button>
    <button id="zoomIn">🔍 +</button>
    <button id="zoomOut">🔍 –</button>
  </div>

   <script>
  // Array global para llevar registro de los aportes cargados
  let ultimosAportes = [];

  document.addEventListener('DOMContentLoaded', () => {
    if (!verificarToken()) return;

    usuario = obtenerUsuarioDesdeToken();
    console.log('👤 Usuario cargado desde token:', usuario);

    // Referencias DOM
    const mural = document.getElementById("mural");
    const formulario = document.getElementById("formularioPrincipal");
    const misAportes = document.getElementById("misAportes");
    const btnFormulario = document.getElementById("btnMostrarFormulario");
    const btnAportes = document.getElementById("btnMostrarAportes");
    const zoomInBtn = document.getElementById("zoomIn");
    const zoomOutBtn = document.getElementById("zoomOut");
    const btnCompartir = document.getElementById("btnCompartir");
    const btnCerrarModal = document.getElementById("btnCerrarModal");
    const modalOverlay = document.getElementById("modalOverlay");

    // Cerrar modal inicial
    if (btnCerrarModal && modalOverlay) {
      btnCerrarModal.addEventListener('click', () => {
        if (document.getElementById('noMostrarCheckbox').checked) {
          localStorage.setItem('noMostrarMensajeMural', 'true');
        }
        modalOverlay.style.display = 'none';
      });
    }

    // Validación mínima
    if (!mural || !formulario || !misAportes || !btnFormulario || !btnAportes || !zoomInBtn || !zoomOutBtn || !btnCompartir) {
      console.error("❌ Faltan elementos del DOM requeridos.");
      return;
    }

    // Toggle formulario / mis aportes
    btnFormulario.addEventListener("click", () => {
      const vis = formulario.classList.toggle("mostrar");
      btnFormulario.textContent = vis ? "✖ Cerrar" : "✚ Aportar";
      if (vis) misAportes.classList.remove("mostrar");
    });
    btnAportes.addEventListener("click", () => {
      const vis = misAportes.classList.toggle("mostrar");
      btnAportes.textContent = vis ? "✖ Cerrar" : "📁 Aportes";
      if (vis) formulario.classList.remove("mostrar");
    });

    // Zoom
    zoomInBtn.addEventListener("click", () => mural.style.transform = "scale(1.1)");
    zoomOutBtn.addEventListener("click", () => mural.style.transform = "scale(0.9)");

    // Compartir aporte
    btnCompartir.addEventListener("click", agregarAlMural);

    // Mostrar modal si no marcamos "no mostrar"
    if (!localStorage.getItem('noMostrarMensajeMural')) {
      modalOverlay.style.display = 'flex';
    }

    // Carga inicial
    cargarAportes();
  });

  // Decodifica usuario del JWT
  function obtenerUsuarioDesdeToken() {
    const t = localStorage.getItem('token');
    if (!t) return null;
    try {
      const p = JSON.parse(atob(t.split('.')[1]));
      return p.username;
    } catch {
      return null;
    }
  }

  // Verifica que haya token
  function verificarToken() {
    if (!localStorage.getItem('token')) {
      alert('Debes iniciar sesión para usar el mural.');
      window.location.href = '/index.html';
      return false;
    }
    return true;
  }

  // Agrega un aporte: imagem, frase, emoji o doodle
  async function agregarAlMural() {
    const tipo = document.getElementById('tipo').value;
    const contenidoEl = document.getElementById('contenido');
    const imagenInput = document.getElementById('imagenInput');
    const canvas = document.getElementById('canvasDoodle');

    let contenidoFinal = '';
    if (tipo === 'frase' || tipo === 'emoji') {
      if (!contenidoEl.value.trim()) return alert('Escribe algo primero.');
      contenidoFinal = contenidoEl.value.trim();
      contenidoEl.value = '';
    }
    else if (tipo === 'imagen') {
      const file = imagenInput.files[0];
      if (!file) return alert('Selecciona una imagen.');
      // sube primero la imagen al endpoint /image
      const fd = new FormData();
      fd.append('imagen', file);
      fd.append('usuario', usuario);
      try {
        const resImg = await fetch('https://momento-backend-production.up.railway.app/api/mural/image', {
          method: 'POST', body: fd
        });
        const jsonImg = await resImg.json();
        if (!resImg.ok) throw new Error(jsonImg.message);
        contenidoFinal = jsonImg.data.contenido;  // URL de la imagen
        imagenInput.value = '';
        document.getElementById('preview').style.display = 'none';
      } catch (e) {
        return alert('Error subiendo imagen: ' + e.message);
      }
    }
    else if (tipo === 'doodle') {
      contenidoFinal = document.getElementById('canvasDoodle').toDataURL();
      limpiarCanvas();
    }

    // Finalmente, envía el aporte
    await enviarAlBackend(usuario, tipo, contenidoFinal);
  }

  // Limpia el canvas
  function limpiarCanvas() {
    const c = document.getElementById('canvasDoodle');
    c.getContext('2d').clearRect(0, 0, c.width, c.height);
  }

  // Envia al backend y actualiza mural + “mis aportes”
  async function enviarAlBackend(data) {
  const token = localStorage.getItem("token"); // Asegúrate de que esté guardado correctamente

  try {
    const res = await fetch("https://momento-backend-production.up.railway.app/api/mural", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}`, // 👈 Agregado correctamente
      },
      body: JSON.stringify(data),
    });

    if (!res.ok) {
      throw new Error("Error al enviar el aporte");
    }

    return await res.json();
  } catch (error) {
    console.error("Error", error);
    throw error;
  }
}

  // Renderiza un aporte suelto en el mural
  function mostrarAporte({ _id, tipo, contenido, usuario }) {
    const mural = document.getElementById('mural');
    const div = document.createElement('div');
    div.className = 'mural-item ' + tipo;
    div.id = `aporte-${_id}`;
    // posición aleatoria dentro de mural
    const { offsetWidth: w, offsetHeight: h } = mural;
    const x = Math.random() * (w - 200), y = Math.random() * (h - 200);
    div.style.left = `${x}px`;
    div.style.top = `${y}px`;
    if (tipo === 'imagen' || tipo === 'doodle') {
      const img = new Image();
      img.src = contenido;
      div.appendChild(img);
    } else {
      div.textContent = contenido;
    }
    div.title = `Por ${usuario}`;
    mural.appendChild(div);
  }

  // Carga y muestra todas las aportes del día
  async function cargarAportes() {
    try {
      const res = await fetch('https://momento-backend-production.up.railway.app/api/mural/today');
      const datos = await res.json();
      ultimosAportes = datos;
      // muestra en mural y en “mis aportes”
      datos.forEach(mostrarAporte);
      mostrarMisAportes(datos);
    } catch (e) {
      console.error('Error al cargar el mural:', e);
    }
  }

  // Muestra la lista “Mis Aportes”
  function mostrarMisAportes(datos) {
    const cont = document.getElementById('listaMisAportes');
    cont.innerHTML = '';
    const ahora = Date.now();
    datos
      .filter(a => a.usuario === usuario)
      .forEach(a => {
        const div = document.createElement('div');
        div.className = 'aporte-propio';
        div.textContent = `• ${a.tipo}`;
        // calculo expiración
        const creado = new Date(a.fechaCreacion).getTime();
        const restanteMin = Math.max(0, Math.floor((creado + 6*3600*1000 - ahora)/60000));
        const span = document.createElement('span');
        span.className = 'tiempo-restante';
        span.textContent = ` ⏳ ${restanteMin}min`;
        div.appendChild(span);
        cont.appendChild(div);
      });
  }
</script>
</body>
</html>
