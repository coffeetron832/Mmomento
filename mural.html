<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Cache-Control" content="no-store" />
  <title>El Mural del Momento</title>
  <script src="https://unpkg.com/lucide@latest"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/estilos-mural.css" />
  <style>
  :root {
    --bg: #000;
    --text: #eee;
    --subtle: #aaa;
    --accent: #5a9bd8;
    --banner-bg: rgba(90, 155, 216, 0.9);
  }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Inter', sans-serif;
  }

  .welcome-banner {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--banner-bg);
    color: var(--text);
    padding: 12px 24px;
    border-radius: 12px;
    font-size: 1rem;
    z-index: 9999;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.5s ease-in-out, background 0.3s ease;
  }

  .fade-in {
    opacity: 1;
  }
  .fade-out {
    opacity: 0;
  }
  .hidden {
    display: none;
  }

  #logoutBtn {
    position: fixed;
    top: 20px;
    right: 20px;
    background: transparent;
    border: none;
    cursor: pointer;
    font-size: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--text);
    z-index: 10000;
    transition: color 0.2s ease;
  }
  #logoutBtn:hover {
    color: var(--accent);
  }


    /* Modal container: fondo oscuro, padding y borde sutil */
#mensajeInicial.modal {
  position: relative; /* <-- CLAVE para contener los slides animados */
  background: #111;
  padding: 1.5rem;
  border-radius: 8px;
  border: 1px solid var(--subtle);
  max-width: 500px;
  margin: 2rem auto;
  box-shadow: 0 4px 10px rgba(0,0,0,0.5);
  overflow: hidden; /* Previene que el contenido animado “se salga” */
}

/* Mejora de tipografía dentro del modal */
.modal-slide p {
  text-align: justify;
  line-height: 1.6;
  font-size: 1rem;
  max-width: 100%;
  margin-bottom: 1rem;
}


/* Botones y controles: un poco más de espaciado */
.modal-controls {
  margin-top: 1.5rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.modal-controls button {
  background: none;
  border: none;
  cursor: pointer;
  font-size: 1.2rem;
  opacity: 0.7;
  transition: opacity 0.3s, transform 0.3s;
  color: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
}

.modal-controls button:hover {
  opacity: 1;
  transform: scale(1.1);
}


    .modal-slide {
  opacity: 0;
  pointer-events: none;
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  transform: translateX(30px);
  transition: opacity 0.5s ease, transform 0.5s ease;
}

.modal-slide.active {
  opacity: 1;
  pointer-events: auto;
  position: relative;
  transform: translateX(0);
}


#notifPanel {
  position: fixed;
  top: 60px;
  right: 20px;
  width: 300px;
  background: #111;
  color: #eee;
  border: 1px solid var(--subtle);
  border-radius: 8px;
  padding: 1rem;
  max-height: 400px;
  overflow-y: auto;
  z-index: 9998;
}

#notifPanel.hidden {
  display: none;
}

#notifPanel h3 {
  margin-top: 0;
  font-size: 1.1rem;
  color: var(--accent);
}

#notifList li {
  padding: 8px;
  border-bottom: 1px solid #333;
  font-size: 0.95rem;
}


</style>
</head>
<body>
  <div id="welcome-banner" class="welcome-banner hidden"></div>

  <button id="logoutBtn" title="Cerrar sesión">
    <i data-lucide="log-out"></i>
    <span>Cerrar sesión</span>
  </button>

<button id="notifBtn" title="Ver notificaciones">
  <i data-lucide="bell"></i>
  <span>Notificaciones</span>
  <span id="notifBadge" style="color: red; margin-left: 4px;"></span>
</button>

  
  <div id="modalOverlay">
  <div id="mensajeInicial" class="modal">
    
    <div class="modal-slide active">
      <p>🎉 <strong>Bienvenido a TheMural</strong><br>
      Este espacio no es para aparentar. Es para soltar.  
      ¿Un pensamiento que no cabe en WhatsApp? ¿Un dibujo hecho con el dedo? ¿Una frase que te salvó el día? Suéltala acá.  
      TheMural es como un lienzo público, pero sin postureo.</p>
    </div>

    <div class="modal-slide">
      <p>📏 <strong>Normas básicas (porque siempre hay uno que se pasa)</strong><br>
      • No se permiten mensajes de odio, violencia o “humor negro” con complejo de víctima.<br>
      • Nada de autopromoción. Si quieres vender algo, este no es tu lugar.<br>
      • Lo que publiques debe tener alma, no likes.<br>
      • No ofendas. Aunque sea con indirectas pasivo-agresivas.</p>
    </div>

    <div class="modal-slide">
      <p>🧠 <strong>¿Por qué existe TheMural?</strong><br>
      Porque a veces uno necesita decir algo y ya. Sin explicarlo.  
      Sin esperar respuestas. Sin filtro.<br>
      Esto es un espacio para expresarte sin pedir permiso.  
      No hay algoritmo, ni jueces, ni etiquetas.</p>
    </div>

    <div class="modal-slide">
      <p>🖍️ <strong>Consejos útiles (y cero cursilerías)</strong><br>
      • Escribe lo que de verdad sientes, no lo que suena bonito.<br>
      • Comparte algo solo si te nace. No hay obligación de “ser profundo”.<br>
      • Si no tienes nada que decir... observa. Eso también vale.<br>
      • Vuelve cuando quieras. Esto no es una cita, es un desahogo.</p>
    </div>

    <div class="modal-controls">
      <button id="prevBtn" onclick="cambiarSlide(-1)">
        <i data-lucide="arrow-left-circle"></i>
      </button>
      <button id="nextBtn" onclick="cambiarSlide(1)">
        <i data-lucide="arrow-right-circle"></i>
      </button>
    </div>

    <label><input type="checkbox" id="noMostrarCheckbox"> No volver a mostrar</label>
    <br />
    <button onclick="cerrarMensaje()">Cerrar</button>
  </div>
</div>

  <section class="formulario flotante popover">
  <label for="contenido">¿Qué estás sintiendo hoy?</label>
  <textarea id="contenido" placeholder="Escribe tu aporte emocional..." rows="4" style="width: 100%; resize: vertical;"></textarea>
  <button onclick="agregarAlMural()">Compartir en el Mural</button>
</section>


  <div id="zoomControls">
    <button id="zoomIn">+</button>
    <button id="zoomOut">–</button>
  </div>

  <div id="muralContainer">
    <section id="mural" class="mural"></section>
  </div>

  <div id="misAportes" class="popover">
    <h3>Mis Aportes</h3>
    <div id="listaMisAportes"></div>
  </div>

  <div id="footerButtons">
    <button id="btnFormulario" class="btn-popover" title="Aportar al mural">
      <i data-lucide="plus-circle"></i> Aportar
    </button>
    <button id="btnMisAportes" class="btn-popover" title="Ver mis aportes">
      <i data-lucide="bookmark"></i> Mis Aportes
    </button>
    <a id="btnSoulprint" href="soulprint.html" class="btn-popover">
  <i data-lucide="user"></i>
  <span>Mi Soulprint</span>
</a>


  </div>


  <div id="notifPanel" class="popover hidden">
  <h3>Notificaciones</h3>
  <ul id="notifList" style="list-style: none; padding: 0;"></ul>
</div>

  <script src="/js/mural.js"></script>
  <script>
    lucide.createIcons();

    
  let currentSlide = 0;
const slides = document.querySelectorAll('.modal-slide');

function cambiarSlide(direccion) {
  // Quita la clase active: dispara animación de salida
  slides[currentSlide].classList.remove('active');

  // Calcula nueva posición
  currentSlide = (currentSlide + direccion + slides.length) % slides.length;

  // Añade la clase active: dispara animación de entrada
  slides[currentSlide].classList.add('active');
}



    
    document.addEventListener("DOMContentLoaded", () => {
      const API_BASE_URL = 'https://momento-backend-production.up.railway.app';

      // 🔒 Verificar si hay sesión activa
(async () => {
  try {
    const token = localStorage.getItem("token");
    const res = await fetch(`${API_BASE_URL}/api/users/me`, {
  headers: {
    Authorization: `Bearer ${token}`,
  },
});


    if (!res.ok) {
      localStorage.clear(); // Borra cualquier sesión inválida
      window.location.href = "/index.html";
    }
  } catch (err) {
    console.error("Error verificando sesión:", err);
    window.location.href = "/index.html";
  }
})();


      const token = localStorage.getItem("token");

async function cargarNotificaciones() {
  try {
    const res = await fetch(`${API_BASE_URL}/api/notifications`, {
      headers: {
        Authorization: `Bearer ${token}`
      }
    });

    if (!res.ok) return;

    const data = await res.json();
    const notifList = document.getElementById("notifList");
    const notifBadge = document.getElementById("notifBadge");

    notifList.innerHTML = "";

    if (data.length > 0) {
      notifBadge.textContent = `(${data.length})`;
    } else {
      notifBadge.textContent = "";
    }

    data.forEach((notif) => {
      const li = document.createElement("li");
      li.innerHTML = `<strong>${notif.sender.username}:</strong> ${notif.message}`;
      notifList.appendChild(li);
    });

  } catch (err) {
    console.error("Error al cargar notificaciones:", err);
  }
}

// Alternar panel
document.getElementById("notifBtn").addEventListener("click", () => {
  const panel = document.getElementById("notifPanel");
  panel.classList.toggle("hidden");
});

// Cargar notificaciones al inicio
cargarNotificaciones();


      // ✅ Mostrar mensaje de bienvenida
      const banner = document.getElementById("welcome-banner");
      const message = localStorage.getItem("welcomeBackMessage");

      if (message && banner) {
        banner.textContent = message;
        banner.classList.remove("hidden");
        banner.classList.add("fade-in");

        localStorage.removeItem("welcomeBackMessage");

        setTimeout(() => banner.classList.add("fade-out"), 3000);
        setTimeout(() => banner.remove(), 4000);
      }

      // 🔒 Cerrar sesión
      const logoutBtn = document.getElementById("logoutBtn");
      if (logoutBtn) {
        logoutBtn.addEventListener("click", () => {
          localStorage.clear();
          history.replaceState(null, null, "/index.html");
          window.location.href = "/index.html";
        });
      }
    });
  </script>
</body>
</html>
