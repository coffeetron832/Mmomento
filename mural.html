<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>El Mural del Momento</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/estilos-mural.css" />
</head>
<body>

  <!-- Modal inicial -->
  <div id="modalOverlay">
    <div id="mensajeInicial" class="modal">
      <p>üß± El Mural del Momento es un lienzo ef√≠mero donde puedes dejar tu huella emocional del d√≠a: frases, emojis, im√°genes o dibujos. Todo desaparece a medianoche.</p>
      <label><input type="checkbox" id="noMostrarCheckbox"> No volver a mostrar</label>
      <br/>
      <button id="btnCerrarModal">Cerrar</button>
    </div>
  </div>

  <!-- Formulario flotante -->
  <section class="formulario flotante" id="formularioPrincipal">
    <label>¬øQu√© quieres dejar hoy?</label>
    <select id="tipo">
      <option value="frase">‚úçÔ∏è Frase corta</option>
      <option value="emoji">üòÑ Emoji gigante</option>
      <option value="imagen">üñºÔ∏è Imagen (m√°x. 400x400px)</option>
      <option value="doodle">üé® Doodle r√°pido</option>
    </select>
    <input type="text" id="contenido" placeholder="Escribe algo..." />
    <input type="file" id="imagenInput" accept="image/*" style="display:none;" />
    <div class="doodle-controls" id="doodleControls" style="display:none;">
      <label>Color:</label>
      <input type="color" id="colorPicker" value="#222222">
      <button type="button" id="btnLimpiarDoodle">üßº Borrar doodle</button>
    </div>
    <canvas id="canvasDoodle" width="300" height="300"></canvas>
    <div class="preview" id="preview" style="display:none;">
      <strong>Vista previa:</strong>
      <img id="previewImg" src="" alt="Previsualizaci√≥n" />
    </div>
    <button id="btnCompartir">Compartir en el Mural</button>
  </section>

  <!-- Panel ‚ÄúMis Aportes‚Äù -->
  <div id="misAportes">
    <h3>Mis Aportes</h3>
    <div id="listaMisAportes"></div>
  </div>

  <!-- Contenedor del mural -->
  <div id="muralContainer">
    <div id="mural" class="mural-contenedor"></div>
  </div>

  <!-- Footer con acciones y zoom -->
  <div class="footer-controles">
    <button id="btnMostrarFormulario">‚úö Aportar</button>
    <button id="btnMostrarAportes">üìÅ Aportes</button>
    <button id="zoomIn">üîç +</button>
    <button id="zoomOut">üîç ‚Äì</button>
  </div>

  <script>
  document.addEventListener("DOMContentLoaded", () => {
    // Referencias
    const modalOverlay = document.getElementById("modalOverlay");
    const btnCerrarModal = document.getElementById("btnCerrarModal");
    const noMostrarCheckbox = document.getElementById("noMostrarCheckbox");

    const tipo = document.getElementById("tipo");
    const contenido = document.getElementById("contenido");
    const imagenInput = document.getElementById("imagenInput");
    const preview = document.getElementById("preview");
    const previewImg = document.getElementById("previewImg");
    const canvas = document.getElementById("canvasDoodle");
    const ctx = canvas.getContext("2d");
    const colorPicker = document.getElementById("colorPicker");
    const btnLimpiarDoodle = document.getElementById("btnLimpiarDoodle");

    const formulario = document.getElementById("formularioPrincipal");
    const misAportes = document.getElementById("misAportes");
    const btnMostrarFormulario = document.getElementById("btnMostrarFormulario");
    const btnMostrarAportes = document.getElementById("btnMostrarAportes");
    const btnCompartir = document.getElementById("btnCompartir");

    const mural = document.getElementById("mural");
    const zoomInBtn = document.getElementById("zoomIn");
    const zoomOutBtn = document.getElementById("zoomOut");
    const muralContainer = document.getElementById("muralContainer");

    // Verificar token
    function verificarToken() {
      const token = localStorage.getItem("token");
      if (!token) {
        alert("Debes iniciar sesi√≥n para usar el mural.");
        window.location.href = "/index.html";
        return false;
      }
      return true;
    }
    if (!verificarToken()) return;

    // Cerrar modal
    btnCerrarModal.addEventListener("click", () => {
      if (noMostrarCheckbox.checked) {
        localStorage.setItem("noMostrarMensaje", "true");
      }
      modalOverlay.style.display = "none";
    });

    // Tipo cambia visibilidad
    tipo.addEventListener("change", () => {
      const val = tipo.value;
      contenido.style.display = (val === "imagen" || val === "doodle") ? "none" : "block";
      imagenInput.style.display = (val === "imagen") ? "block" : "none";
      canvas.style.display = (val === "doodle") ? "block" : "none";
      btnLimpiarDoodle.style.display = (val === "doodle") ? "inline-block" : "none";
      preview.style.display = (val === "imagen") ? "block" : "none";
    });

    // Previsualizar imagen
    imagenInput.addEventListener("change", () => {
      const file = imagenInput.files[0];
      if (!file) return;
      const img = new Image();
      const reader = new FileReader();
      reader.onload = e => {
        img.onload = () => {
          if (img.width > 400 || img.height > 400) {
            alert("La imagen supera los 400√ó400px.");
            imagenInput.value = "";
            previewImg.src = "";
            return;
          }
          previewImg.src = e.target.result;
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    });

    // Doodle
    let drawing = false;
    canvas.addEventListener("mousedown", () => drawing = true);
    canvas.addEventListener("mouseup",   () => drawing = false);
    canvas.addEventListener("mouseleave",() => drawing = false);
    canvas.addEventListener("mousemove", e => {
      if (!drawing) return;
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      ctx.fillStyle = colorPicker.value;
      ctx.beginPath();
      ctx.arc(x, y, 2, 0, Math.PI*2);
      ctx.fill();
    });
    btnLimpiarDoodle.addEventListener("click", () => ctx.clearRect(0,0,canvas.width,canvas.height));

    // Mostrar/Ocultar formulario y aportes
    btnMostrarFormulario.addEventListener("click", () => {
      formulario.classList.toggle("mostrar");
      misAportes.classList.remove("mostrar");
      btnMostrarFormulario.textContent = formulario.classList.contains("mostrar") ? "‚úñ Cerrar" : "‚úö Aportar";
      btnMostrarAportes.textContent = "üìÅ Aportes";
    });
    btnMostrarAportes.addEventListener("click", () => {
      misAportes.classList.toggle("mostrar");
      formulario.classList.remove("mostrar");
      btnMostrarAportes.textContent = misAportes.classList.contains("mostrar") ? "‚úñ Cerrar" : "üìÅ Aportes";
      btnMostrarFormulario.textContent = "‚úö Aportar";
    });

    // Zoom simple
    zoomInBtn.addEventListener("click",  ()=> muralContainer.style.transform = "scale(1.1)");
    zoomOutBtn.addEventListener("click", ()=> muralContainer.style.transform = "scale(0.9)");

    // Agregar al mural
    async function agregarAlMural() {
      const tipoSel = tipo.value;
      let contenidoFinal = "";
      if (tipoSel === "frase" || tipoSel === "emoji") {
        if (!contenido.value.trim()) return alert("Escribe algo primero.");
        contenidoFinal = contenido.value.trim();
        contenido.value = "";
      } else if (tipoSel === "imagen") {
        const file = imagenInput.files[0];
        if (!file) return alert("Selecciona una imagen.");
        // aqu√≠ enviar formData al backend...
        return;
      } else {
        contenidoFinal = canvas.toDataURL();
        ctx.clearRect(0,0,canvas.width,canvas.height);
      }
      // ... y luego actualizarlo localmente:
      mostrarAporte({ tipo: tipoSel, contenido: contenidoFinal, usuario: localStorage.getItem("username") });
    }
    btnCompartir.addEventListener("click", agregarAlMural);

    // Renderizar aporte
    function mostrarAporte({ tipo, contenido, usuario }) {
      const item = document.createElement("div");
      item.className = "mural-item " + tipo;
      item.title = `Por ${usuario}`;
      if (tipo === "imagen" || tipo === "doodle") {
        const img = new Image();
        img.src = contenido;
        item.appendChild(img);
      } else {
        item.textContent = contenido;
      }
      mural.appendChild(item);
    }

    // Cargar desde el backend
    async function cargarAportes() {
      try {
        const API = window.location.hostname.includes("localhost")
          ? "http://localhost:8000"
          : "https://momento-backend-production.up.railway.app";
        const res = await fetch(`${API}/api/aportes`);
        const datos = await res.json();
        datos.forEach(mostrarAporte);
      } catch (err) {
        console.error("Error al cargar el mural:", err);
      }
    }
    cargarAportes();

  });
  </script>
</body>
</html>
