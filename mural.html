<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>El Mural del Momento</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/estilos-mural.css" />
</head>
<body>

<div id="modalOverlay">
  <div id="mensajeInicial" class="modal">
    <p>ğŸ§± El Mural del Momento es un lienzo efÃ­mero donde puedes dejar tu huella emocional del dÃ­a: frases, emojis, imÃ¡genes o dibujos. Todo desaparece a medianoche.</p>
    <label><input type="checkbox" id="noMostrarCheckbox"> No volver a mostrar</label>
    <br />
    <button onclick="cerrarMensaje()">Cerrar</button>
  </div>
</div>

<!-- ğŸ”§ Formulario adicional requerido por el JS -->
<button id="btnMostrarFormulario" style="display:none;">âœš Aportar (invisible para compatibilidad)</button>
<div id="formularioAporte" class="oculto" style="display:none;">
  <input type="file" id="inputImagen" />
  <input type="text" id="descripcion" placeholder="Escribe una descripciÃ³n..." />
  <button id="cerrarFormulario">âŒ Cerrar</button>
</div>

<section class="formulario flotante">
  <label>Â¿QuÃ© quieres dejar hoy?</label>
  <select id="tipo">
    <option value="frase">âœï¸ Frase corta</option>
    <option value="emoji">ğŸ˜„ Emoji gigante</option>
    <option value="imagen">ğŸ–¼ï¸ Imagen (mÃ¡x. 400x400px)</option>
    <option value="doodle">ğŸ¨ Doodle rÃ¡pido</option>
  </select>

  <input type="text" id="contenido" placeholder="Escribe algo..." />
  <input type="file" id="imagenInput" accept="image/*" style="display:none;" />
  <div class="doodle-controls" id="doodleControls" style="display:none;">
    <label>Color:</label>
    <input type="color" id="colorPicker" value="#222222">
    <button type="button" onclick="limpiarCanvas()">ğŸ§¼ Borrar doodle</button>
  </div>
  <canvas id="canvasDoodle" width="300" height="300"></canvas>

  <div class="preview" id="preview">
    <strong>Vista previa:</strong>
    <img id="previewImg" src="" alt="PrevisualizaciÃ³n" />
  </div>

  <button onclick="agregarAlMural()">Compartir en el Mural</button>
</section>

<!-- Panel flotante con aportes del usuario -->
<div id="misAportes">
  <h3>Mis Aportes</h3>
  <div id="listaMisAportes"></div>
</div>

  <!-- Contenedor del mural -->
<div id="mural" class="mural-contenedor">
  <!-- AquÃ­ se renderizan los aportes -->
</div>


<div class="footer-controles">
  <!-- Botones de acciÃ³n -->
  <button class="toggle-ui-btn" id="btnMostrarFormulario">âœš Aportar</button>
  <button class="toggle-aportes-btn" id="btnMostrarAportes">ğŸ“ Aportes</button>

  <!-- Controles de zoom -->
  <button id="zoomIn">ğŸ” +</button>
  <button id="zoomOut">ğŸ” â€“</button>
</div>

<script>

  document.addEventListener("DOMContentLoaded", () => {
  const token = localStorage.getItem("token");
  const user = localStorage.getItem("username");
  const mural = document.getElementById("mural");
  const btnMostrarFormulario = document.getElementById("btnMostrarFormulario");
  const formularioAporte = document.getElementById("formularioAporte");
  const cerrarFormularioBtn = document.getElementById("cerrarFormulario");
  const inputImagen = document.getElementById("inputImagen");

  // Mostrar usuario
  if (user) console.log("ğŸ‘¤ Usuario cargado desde token:", user);

  // ValidaciÃ³n de elementos esenciales
  if (!mural || !btnMostrarFormulario || !formularioAporte || !cerrarFormularioBtn || !inputImagen) {
    console.error("âŒ Faltan elementos del DOM requeridos.");
    return;
  }

  // Mostrar formulario
  btnMostrarFormulario.addEventListener("click", () => {
    formularioAporte.classList.remove("oculto");
  });

  // Cerrar formulario
  cerrarFormularioBtn.addEventListener("click", () => {
    formularioAporte.classList.add("oculto");
  });

function cerrarMensaje() {
  const overlay = document.getElementById("modalOverlay");
  const checkbox = document.getElementById("noMostrarCheckbox");

  if (checkbox.checked) {
    localStorage.setItem("noMostrarMensaje", "true");
  }

  if (overlay) {
    overlay.style.display = "none";
  }
}

    
  // Mostrar aporte en el mural
  function mostrarAporte(aporte) {
    const { imagenUrl, descripcion, usuario } = aporte;

    if (!imagenUrl || !descripcion || !usuario) return;

    const div = document.createElement("div");
    div.className = "aporte";

    const img = document.createElement("img");
    img.src = imagenUrl;
    img.alt = descripcion;

    const p = document.createElement("p");
    p.textContent = descripcion;

    const autor = document.createElement("span");
    autor.textContent = `Por ${usuario}`;

    div.appendChild(img);
    div.appendChild(p);
    div.appendChild(autor);

    mural.appendChild(div);
  }

  // Cargar aportes existentes
  async function cargarAportes() {
    try {
      const res = await fetch("/api/aportes");
      const data = await res.json();

      console.log("ğŸ§© Aportes recibidos:", data);
      console.log("ğŸ‘¤ Usuario localStorage:", user);

      data.forEach(aporte => mostrarAporte(aporte));
    } catch (error) {
      console.error("Error al cargar el mural:", error);
    }
  }

  cargarAportes();
});
</script>
</body>
</html>
