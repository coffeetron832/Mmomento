<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>El Mural del Momento</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/estilos-mural.css" />
</head>
<body>
 <div id="modalOverlay">
  <div id="mensajeInicial" class="modal">
    <p>üß± El Mural del Momento es un lienzo ef√≠mero donde puedes dejar tu huella emocional del d√≠a: frases, emojis, im√°genes o dibujos. Todo desaparece a medianoche.</p>
    <label><input type="checkbox" id="noMostrarCheckbox"> No volver a mostrar</label>
    <br />
    <button onclick="cerrarMensaje()">Cerrar</button>
  </div>
</div>

  <button id="toggleUIBtn" style="
  position: fixed;
  bottom: 1rem;
  left: 1rem;
  z-index: 10000;
  background: #ff9a9e;
  color: black;
  font-weight: bold;
  border: none;
  border-radius: 2rem;
  padding: 0.6rem 1.2rem;
  font-size: 1rem;
  box-shadow: 0 4px 8px rgba(0,0,0,0.3);
  display: none;
">
  üëÅÔ∏è Mostrar
</button>


  <section class="formulario flotante">
    <label>¬øQu√© quieres dejar hoy?</label>
    <select id="tipo">
      <option value="frase">‚úçÔ∏è Frase corta</option>
      <option value="emoji">üòÑ Emoji gigante</option>
      <option value="imagen">üñºÔ∏è Imagen (m√°x. 400x400px)</option>
      <option value="doodle">üé® Doodle r√°pido</option>
    </select>

    <input type="text" id="contenido" placeholder="Escribe algo..." />
    <input type="file" id="imagenInput" accept="image/*" style="display:none;" />
    <div class="doodle-controls" id="doodleControls" style="display:none;">
      <label>Color:</label>
      <input type="color" id="colorPicker" value="#222222">
      <button type="button" onclick="limpiarCanvas()">üßº Borrar doodle</button>
    </div>
    <canvas id="canvasDoodle" width="300" height="300"></canvas>

    <div class="preview" id="preview">
      <strong>Vista previa:</strong>
      <img id="previewImg" src="" alt="Previsualizaci√≥n" />
    </div>

    <button onclick="agregarAlMural()">Compartir en el Mural</button>
  </section>

<!-- Controles de zoom solo visibles en m√≥viles -->
<div id="zoomControls" class="solo-movil">
  <button id="zoomIn">+</button>
  <button id="zoomOut">‚Äì</button>
</div>


<!-- Contenedor del mural para pan/zoom -->
<div id="muralContainer">
  <section id="mural" class="mural"></section>
</div>

  <!-- Panel flotante con aportes del usuario -->
<div id="misAportes">
  <h3>Mis Aportes</h3>
  <div id="listaMisAportes"></div>
</div>

  <script>
  let usuario; // Variable global

  function obtenerUsuarioDesdeToken() {
    const token = localStorage.getItem('token');
    if (!token) return null;

    try {
      const payloadBase64 = token.split('.')[1];
      const payloadDecoded = atob(payloadBase64);
      const payload = JSON.parse(payloadDecoded);
      return payload.username;
    } catch (err) {
      console.error('Error decodificando token:', err);
      return null;
    }
  }

  function verificarToken() {
    const token = localStorage.getItem('token');
    if (!token) {
      alert('Debes iniciar sesi√≥n para usar el mural.');
      window.location.href = '/index.html';
      return false;
    }
    return true;
  }

  window.addEventListener('DOMContentLoaded', () => {
    if (!verificarToken()) return;
    usuario = obtenerUsuarioDesdeToken();
    console.log('üë§ Usuario cargado desde token:', usuario);
    cargarAportes();

    // Mostrar bot√≥n de UI en m√≥vil
    if (window.innerWidth <= 600) {
      document.getElementById('toggleUIBtn').style.display = 'block';
    }

    // Mostrar mensaje inicial si aplica
    if (!localStorage.getItem('noMostrarMensajeMural')) {
      document.getElementById('mensajeInicial').style.display = 'block';
    }

    // Borrar mural si es nuevo d√≠a
    const hoy = new Date().toDateString();
    const ultimaVisita = localStorage.getItem('muralFecha');
    if (ultimaVisita !== hoy) {
      localStorage.setItem('muralFecha', hoy);
      document.getElementById('mural').innerHTML = '';
    }
  });

  function cerrarMensaje() {
    const noMostrar = document.getElementById('noMostrarCheckbox').checked;
    if (noMostrar) {
      localStorage.setItem('noMostrarMensajeMural', 'true');
    }
    const overlay = document.getElementById('modalOverlay');
    overlay.classList.add('hidden');
    overlay.style.display = 'none';
  }

  const palabrasProhibidas = ['odio', 'muerte', 'est√∫pido', 'imb√©cil'];
  const tiempoSuspension = 30 * 60 * 1000;

  function contienePalabraProhibida(texto) {
    const palabras = texto.toLowerCase().split(/\s+/);
    return palabrasProhibidas.some(p => palabras.includes(p));
  }

  function estaSuspendido() {
    const fin = localStorage.getItem('momentoSuspension');
    return fin && Date.now() < parseInt(fin);
  }

  const toggleBtn = document.getElementById('toggleUIBtn');
  const formulario = document.querySelector('.formulario');
  const misAportes = document.getElementById('misAportes');
  let uiVisible = true;

  toggleBtn.addEventListener('click', () => {
    uiVisible = !uiVisible;
    formulario.style.display = uiVisible ? 'flex' : 'none';
    misAportes.style.display = uiVisible ? 'block' : 'none';
    toggleBtn.textContent = uiVisible ? 'üëÅÔ∏è Ocultar' : 'üëÅÔ∏è Mostrar';
  });

  const tipo = document.getElementById('tipo');
  const contenido = document.getElementById('contenido');
  const imagenInput = document.getElementById('imagenInput');
  const mural = document.getElementById('mural');
  const preview = document.getElementById('preview');
  const previewImg = document.getElementById('previewImg');
  const canvas = document.getElementById('canvasDoodle');
  const ctx = canvas.getContext('2d');
  const colorPicker = document.getElementById('colorPicker');
  const doodleControls = document.getElementById('doodleControls');

  tipo.addEventListener('change', () => {
    const val = tipo.value;
    contenido.style.display = val === 'imagen' || val === 'doodle' ? 'none' : 'block';
    imagenInput.style.display = val === 'imagen' ? 'block' : 'none';
    canvas.style.display = val === 'doodle' ? 'block' : 'none';
    doodleControls.style.display = val === 'doodle' ? 'flex' : 'none';
    preview.style.display = val === 'imagen' ? 'block' : 'none';
  });

  imagenInput.addEventListener('change', () => {
    const archivo = imagenInput.files[0];
    if (!archivo) return;
    const reader = new FileReader();
    reader.onload = (e) => {
      const img = new Image();
      img.onload = () => {
        if (img.width > 400 || img.height > 400) {
          alert('La imagen supera los 400x400px.');
          imagenInput.value = '';
          previewImg.src = '';
          return;
        }
        previewImg.src = e.target.result;
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(archivo);
  });

  let drawing = false;

  canvas.addEventListener('mousedown', () => drawing = true);
  canvas.addEventListener('mouseup', () => drawing = false);
  canvas.addEventListener('mouseleave', () => drawing = false);
  canvas.addEventListener('mousemove', (e) => {
    if (!drawing) return;
    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    ctx.fillStyle = colorPicker.value;
    ctx.beginPath();
    ctx.arc(x, y, 2, 0, Math.PI * 2);
    ctx.fill();
  });

  function limpiarCanvas() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
  }

  async function agregarAlMural() {
    if (!verificarToken()) return;

    const tipoSeleccionado = tipo.value;
    let contenidoFinal = '';

    if (tipoSeleccionado === 'frase' || tipoSeleccionado === 'emoji') {
      if (!contenido.value.trim()) return alert('Escribe algo.');
      contenidoFinal = contenido.value.trim();
      contenido.value = '';
    } else if (tipoSeleccionado === 'imagen') {
      const archivo = imagenInput.files[0];
      if (!archivo) return alert('Selecciona una imagen.');

      const formData = new FormData();
      formData.append('imagen', archivo);
      formData.append('usuario', usuario);

      try {
        const res = await fetch('https://momento-backend-production.up.railway.app/api/mural/image', {
          method: 'POST',
          body: formData
        });

        const data = await res.json();
        if (!res.ok) throw new Error(data.message || 'Error al subir imagen.');

        mostrarAporte(data.data);
        imagenInput.value = '';
        previewImg.src = '';
        preview.style.display = 'none';
        return;
      } catch (err) {
        console.error('Error al subir imagen:', err);
        return alert('Error al subir la imagen.');
      }
    } else if (tipoSeleccionado === 'doodle') {
      contenidoFinal = canvas.toDataURL();
      limpiarCanvas();
    }

    await enviarAlBackend(usuario, tipoSeleccionado, contenidoFinal);
  }

  async function enviarAlBackend(usuario, tipo, contenido) {
    try {
      const res = await fetch('https://momento-backend-production.up.railway.app/api/mural', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${localStorage.getItem('token')}`
        },
        body: JSON.stringify({ tipo, contenido })
      });

      const data = await res.json();
      if (!res.ok) throw new Error(data.message || 'No se pudo guardar el aporte');
      mostrarAporte(data.data);
    } catch (err) {
      alert(err.message);
      console.error('Error guardando aporte:', err);
    }
  }

  function mostrarAporte({ _id, tipo, contenido, usuario }) {
    const nuevo = document.createElement('div');
    nuevo.classList.add('mural-item');
    nuevo.id = `aporte-${_id}`;

    const { offsetWidth: w, offsetHeight: h } = mural;
    const x = Math.floor(Math.random() * (w - 200));
    const y = Math.floor(Math.random() * (h - 200));
    const rot = `${Math.floor(Math.random() * 10 - 5)}deg`;
    const scale = `${0.95 + Math.random() * 0.1}`;
    nuevo.style.left = `${x}px`;
    nuevo.style.top = `${y}px`;
    nuevo.style.setProperty('--rot', rot);
    nuevo.style.setProperty('--scale', scale);
    nuevo.title = `Aporte de: ${usuario}`;

    if (tipo === 'frase' || tipo === 'emoji') {
      nuevo.classList.add(tipo);
      nuevo.textContent = contenido;
    } else {
      const img = new Image();
      img.src = contenido;
      img.onload = () => mural.appendChild(nuevo);
      nuevo.appendChild(img);
    }

    mural.appendChild(nuevo);
  }

  async function cargarAportes() {
    try {
      const res = await fetch('https://momento-backend-production.up.railway.app/api/mural/today');
      const datos = await res.json();
      console.log('üß© Aportes recibidos:', datos);

      datos.forEach(mostrarAporte);
      mostrarMisAportes(datos);
    } catch (err) {
      console.error('Error al cargar el mural:', err);
    }
  }

  function mostrarMisAportes(datos) {
    const contenedor = document.getElementById('listaMisAportes');
    contenedor.innerHTML = '';

    const ahora = new Date();

    datos
      .filter(aporte => aporte.usuario === usuario)
      .forEach(aporte => {
        const div = document.createElement('div');
        div.className = 'aporte-propio';

        const span = document.createElement('span');
        span.textContent = `‚Ä¢ ${aporte.tipo}`;

        const tiempoRestante = document.createElement('div');
        tiempoRestante.className = 'tiempo-restante';
        const creado = new Date(aporte.fechaCreacion);
        const expiracion = new Date(creado.getTime() + 6 * 60 * 60 * 1000);
        const minutosRestantes = Math.floor((expiracion - ahora) / 60000);
        tiempoRestante.textContent = `‚è≥ ${minutosRestantes} min restantes`;

        const btnBorrar = document.createElement('button');
        btnBorrar.textContent = '‚úñ';
        btnBorrar.className = 'borrar-aporte';
        btnBorrar.onclick = async () => {
          if (!confirm('¬øEliminar este aporte?')) return;
          const token = localStorage.getItem('token');
          const res = await fetch(`https://momento-backend-production.up.railway.app/api/mural/${aporte._id}`, {
            method: 'DELETE',
            headers: { Authorization: `Bearer ${token}` }
          });

          const data = await res.json();
          if (!res.ok) return alert(data.message || 'Error al eliminar.');

          div.remove();
        };

        div.appendChild(span);
        div.appendChild(btnBorrar);
        div.appendChild(tiempoRestante);
        contenedor.appendChild(div);
      });
  }

  // PING keepalive
  window.addEventListener('beforeunload', () => {
    const token = localStorage.getItem('tokenMomento');
    if (!token) return;
    fetch('/api/ping', {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${token}` },
      keepalive: true
    });
  });

</script>

</body>
</html>
