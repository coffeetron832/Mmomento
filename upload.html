<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>¿Qué vas a dejar ir hoy? | Momento</title>
  <link href="https://fonts.googleapis.com/css2?family=Archivo+Narrow:ital,wght@1,700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/estilos-upload.css" />
  <!-- Guardar nombre para el Mural -->
<script>
  document.addEventListener('DOMContentLoaded', () => {
    try {
      // Asumiendo que en localStorage ya tienes un objeto 'user' con la info del login
      const user = JSON.parse(localStorage.getItem('user'));
      if (user?.username) {
        // Guardamos el username para mural.html
        localStorage.setItem('usuarioMomento', user.username);
      }
    } catch (e) {
      console.warn('No se pudo guardar usuarioMomento:', e);
    }
  });
</script>
</head>  
<body class="upload-page">
  <!-- Panel de exploración emocional -->
<div id="emotionPanel" class="emotion-panel" aria-hidden="true">
  <h2>Explora por emociones</h2>
  <div class="emotion-options">
    <button class="emotion-filter" data-filter="all">🌍 Explora sin brújula</button>
    <button class="emotion-filter" data-filter="caos_bonito">❤️‍🔥 Caos bonito</button>
    <button class="emotion-filter" data-filter="zona_cero">👾 Zona cer0</button>
    <button class="emotion-filter" data-filter="emocional_404">😶‍🌫️ 404 Emocional</button>
    <button class="emotion-filter" data-filter="lo_que_no_se_dice">👻 Nunca antes visto</button>
  </div>
  <button id="closeEmotionPanel" class="close-panel-btn">Cerrar</button>
</div>

  
<!-- Botones ocultos para funcionalidad de Soulprint y Logout -->
<a id="soulprintBtn" href="#" style="display:none;"></a>
<button id="logoutBtn" style="display:none;"></button>
  
  <!-- 🔵 Mensaje flotante para cerrar sesión y otros globales -->
  <div id="uploadSuccessMessage" style="
    display: none;
    position: fixed;
    top: 1rem;
    left: 50%;
    transform: translateX(-50%);
    background-color: #4f46e5;
    color: #fff;
    padding: 1rem 2rem;
    border-radius: 12px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    font-family: 'Roboto', cursive;
    font-size: 1rem;
    z-index: 9999;
    opacity: 0;
    transition: opacity 0.5s ease;
    max-width: 80%;
    text-align: center;
  "></div>

  <!-- 🔹 Mensaje suave dentro del contenido (subida o eliminación de imágenes) -->
  <div class="main-content">
    <div class="container">
      
      <div id="imageActionMessage" style="
        display: none;
    position: fixed;
    top: 1rem;
    left: 50%;
    transform: translateX(-50%);
    background-color: #4f46e5;
    color: #fff;
    padding: 1rem 2rem;
    border-radius: 12px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    font-family: 'Roboto', cursive;
    font-size: 1rem;
    z-index: 9999;
    opacity: 0;
    transition: opacity 0.5s ease;
    max-width: 80%;
    text-align: center;
      ">
        🌟 ¡Tu momento ha sido compartido con el alma!
      </div>

      <!-- El contenido sigue aquí 👇 -->
    <section id="uploadFormContainer" class="upload-form-container" aria-hidden="true">
      

  

  <form id="uploadForm" enctype="multipart/form-data" method="post">

    <!-- 🌅 Imagen emocional primero -->
    <input type="file" id="image" name="image" accept="image/*" required />

    <div id="imagePreviewContainer" style="margin-top: 1rem; display:none;">
      <img id="imagePreview" src="" alt="Vista previa" style="max-width: 100%; border-radius: 8px;" />
    </div>

    <!-- 📝 Descripción emocional -->
    <input type="text" name="description" id="description"
       placeholder="Escribe lo que sientes" required />



    <!-- 🔮 Sección o categoría emocional -->
    <div id="section-buttons" style="margin-top: 1rem; margin-bottom: 1rem;">
      <span class="section-button" data-value="caos_bonito">❤️‍🔥 Caos bonito</span>
      <span class="section-button" data-value="zona_cero">👾 Zona cer0</span>
      <span class="section-button" data-value="404_emocional">😶‍🌫️ 404 Emocional</span>
      <span class="section-button" data-value="nunca_antes_visto">👻 Nunca antes visto</span>
    </div>

    <input type="hidden" name="section" id="selected-section" required>

    <!-- 🔐 Visibilidad -->
    <div style="margin-top: 1rem;">
  <label for="visibility" style="display:block; margin-bottom: 0.25rem;">¿Quién lo verá?</label>
  <select name="visibility" id="visibility">
    <option value="public">🌍 Que lo vea el mundo</option>
    <option value="private">🕶️ Solo yo</option>
    <option value="patch">🫂 Solo mi parche</option>
  </select>
</div>


    <!-- ⏳ Duración emocional -->
    <div style="margin-top: 1rem;">
  <label for="duration" style="display:block; margin-bottom: 0.25rem;">¿Por cuánto tiempo se quedará vivo?</label>
  <select name="duration" id="duration" required>
    <option value="">⏳ Elige su duración...</option>
    <option value="30">30 minutos </option>
    <option value="60">1 hora </option>
    <option value="180">3 horas </option>
    <option value="360">6 horas </option>
  </select>
</div>

    <!-- Después -->
<div id="patchSelectorContainer" style="display: none;">

</div>
  
    <!-- ✨ Botón emocional -->
    <button type="submit" style="margin-top: 1.5rem;">Que vuele</button>
  </form>
</section>
      
<aside class="nav-side-panel">
  <!-- Notificaciones -->
  <div id="notificationsContainer">
    <button id="notifBtn" class="nav-btn" aria-label="Ver notificaciones">
      🔔<span id="notifCount">0</span>
    </button>
  </div>

  <!-- Navegación rápida -->
  <a href="circles.html" class="nav-icon-link" title="Mis parches">🫂</a>
  <a href="mural.html" class="nav-icon-link" title="Ver mural">🎨</a>
  <button id="exploreBtnMenu" class="nav-icon-link" title="Explorar momentos">🌌</button>
  <button id="toggleUploadBtnMenu" class="nav-icon-link" title="Subir imagen">📤</button>

  <!-- Personales -->
  <a href="#" id="soulprintMenuBtn" class="nav-icon-link" title="Mi Soulprint">🧬</a>
  <button id="logoutMenuBtn" class="nav-icon-link" title="Cerrar sesión">🚪</button>
</aside>


<!-- 🔽 Dropdown (MUEVE ESTO FUERA DEL FOOTER) -->
<div id="notifDropdown">
  <ul id="notifList" style="list-style:none;padding:0.5rem;margin:0;"></ul>
</div>


<!-- 🔔 Botón flotante solo visible en móviles -->
<button id="mobileNotifBtn" class="mobile-notif-btn" aria-label="Notificaciones móviles">
  🔔
</button>


<!-- Botón flotante visible solo en móviles -->
<button id="openSidePanelBtn" class="mobile-panel-toggle" aria-label="Abrir panel">
  ☰
</button>


<!-- Modal para gestión de parches -->
<section id="patchManager" class="upload-form-container" aria-hidden="true" style="max-width: 400px;">
  <h2 style="color: var(--btn-text); margin-bottom: 1rem;">Crear nuevo parche</h2>
  
  <form id="createPatchForm">
    <input type="text" id="patchName" placeholder="Nombre del parche" required style="margin-bottom:1rem;"/>
    <button type="submit">Crear parche</button>
  </form>

  <div id="patchMessage" style="margin-top: 1rem; min-height: 1.4rem;"></div>

  <hr style="margin: 1.5rem 0; border-color: var(--notif-border);" />

  <h3 style="color: var(--btn-text); margin-bottom: 0.5rem;">Buscar usuarios para invitar</h3>
  <input type="text" id="userSearch" placeholder="Busca usuarios por nombre o email" style="margin-bottom: 0.75rem;"/>

  <ul id="searchResults" style="list-style:none; padding-left:0; color: var(--btn-text); max-height: 180px; overflow-y: auto;"></ul>

  <button id="closePatchManagerBtn" style="margin-top: 1rem; background-color: var(--btn-hover); color: var(--btn-text); border: none; border-radius: 6px; padding: 0.6rem 1rem; cursor: pointer;">
    Cerrar
  </button>
</section>

      <main id="timeline" role="main" tabindex="0">
        <div id="imagesContainer" class="images-grid" aria-live="polite"></div>
      </main>
    </div>
  </div>

    </div>
  </div>
</footer>

    <div id="menuOverlay" class="menu-overlay" aria-hidden="true">
      <!-- Dentro de .menu-content -->
     <button id="closeMenuBtn" class="close-menu-btn" aria-label="Cerrar menú">
  <img src="assets/icons/x.png" alt="Cerrar" width="24" height="24">
</button>


 <div class="menu-content">
  <button id="logoutMenuBtn" class="footer-link">Cerrar sesión</button>
  <a href="#" id="soulprintMenuBtn" class="footer-link">Mi Soulprint</a>
</div>
</div>

  <!-- Aquí, antes de cerrar body -->
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    

    const buttons = document.querySelectorAll('.sidebar-btn[data-index]');
  const slider = document.getElementById('sliderContent');

  buttons.forEach(btn => {
    btn.addEventListener('click', () => {
      const index = parseInt(btn.getAttribute('data-index'));
      if (!isNaN(index)) {
        // Mover el slider
        slider.style.transform = `translateX(-${index * 100}%)`;

        // Cambiar botón activo
        buttons.forEach(b => b.classList.remove('active-tab'));
        btn.classList.add('active-tab');
      }
    });
  });


    const panel = document.querySelector('.nav-side-panel');
    const openBtn = document.getElementById('openSidePanelBtn');

    // Abrir panel
    openBtn.addEventListener('click', () => {
      panel.classList.add('show');
    });

    // Cerrar panel al hacer clic fuera (opcional)
    document.addEventListener('click', (e) => {
      if (
        panel.classList.contains('show') &&
        !panel.contains(e.target) &&
        e.target !== openBtn
      ) {
        panel.classList.remove('show');
      }
    });


    // Cerrar el formulario al tocar fuera (solo en móviles)
    const uploadFormContainer = document.getElementById('uploadFormContainer');
    const uploadForm = document.getElementById('uploadForm');

    document.addEventListener('click', (e) => {
      const isMobile = window.innerWidth <= 600;

      if (
        isMobile &&
        uploadFormContainer.getAttribute('aria-hidden') === 'false' &&
        !uploadForm.contains(e.target)
      ) {
        uploadFormContainer.setAttribute('aria-hidden', 'true');
        uploadFormContainer.style.display = 'none'; // O quitar clase si usas .active
      }
    });

    
    // ——— Lógica para “Mi Soulprint” ———
    const soulprintMenuBtn = document.getElementById('soulprintMenuBtn');
    let userObj = null;
    try {
      userObj = JSON.parse(localStorage.getItem('user'));
    } catch {}

    if (userObj && userObj.username) {
      soulprintMenuBtn.setAttribute(
        'href',
        `soulprint.html?user=${encodeURIComponent(userObj.username)}`
      );
    } else {
      soulprintMenuBtn.addEventListener('click', e => {
        e.preventDefault();
        alert('Debes iniciar sesión para ver tu Soulprint');
        window.location.href = 'index.html';
      });
    }

    // Cerrar sesión
    const logoutMenuBtn = document.getElementById('logoutMenuBtn');
    logoutMenuBtn.addEventListener('click', () => {
      localStorage.clear();
      window.location.href = 'index.html';
    });
  });

window.addEventListener('beforeunload', () => {
  const token = localStorage.getItem('tokenMomento');
  if (!token) return;

  fetch('/api/ping', {
    method: 'POST',
    headers: { 'Authorization': `Bearer ${token}` },
    keepalive: true
  });
});

    
</script>
  <script src="js/upload2.js"></script>
  <script src="js/upload.js"></script>
</body>
</html>
