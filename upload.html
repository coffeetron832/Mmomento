<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>¿Qué vas a dejar ir hoy? | Momento</title>
  <link href="https://fonts.googleapis.com/css2?family=Archivo+Narrow:ital,wght@1,700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/estilos-upload.css" />
</head>  
<body class="upload-page">
  <!-- Panel de exploración emocional -->
<div id="emotionPanel" class="emotion-panel" aria-hidden="true">
  <h2>Explora por emociones</h2>
  <div class="emotion-options">
    <button class="emotion-filter" data-filter="all">🌍 Explora sin brújula</button>
    <button class="emotion-filter" data-filter="caos_bonito">❤️‍🔥 Caos bonito</button>
    <button class="emotion-filter" data-filter="zona_cero">👾 Zona cer0</button>
    <button class="emotion-filter" data-filter="emocional_404">😶‍🌫️ 404 Emocional</button>
    <button class="emotion-filter" data-filter="lo_que_no_se_dice">👻 Nunca antes visto</button>
  </div>
  <button id="closeEmotionPanel" class="close-panel-btn">Cerrar</button>
</div>

  
<!-- Botones ocultos para funcionalidad de Soulprint y Logout -->
<a id="soulprintBtn" href="#" style="display:none;"></a>
<button id="logoutBtn" style="display:none;"></button>
  
  <!-- 🔵 Mensaje flotante para cerrar sesión y otros globales -->
  <div id="uploadSuccessMessage" style="
    display: none;
    position: fixed;
    top: 1rem;
    left: 50%;
    transform: translateX(-50%);
    background-color: #4f46e5;
    color: #fff;
    padding: 1rem 2rem;
    border-radius: 12px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    font-family: 'Roboto', cursive;
    font-size: 1rem;
    z-index: 9999;
    opacity: 0;
    transition: opacity 0.5s ease;
    max-width: 80%;
    text-align: center;
  "></div>

  <!-- 🔹 Mensaje suave dentro del contenido (subida o eliminación de imágenes) -->
  <div class="main-content">
    <div class="container">
      
      <div id="imageActionMessage" style="
        display: none;
    position: fixed;
    top: 1rem;
    left: 50%;
    transform: translateX(-50%);
    background-color: #4f46e5;
    color: #fff;
    padding: 1rem 2rem;
    border-radius: 12px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    font-family: 'Roboto', cursive;
    font-size: 1rem;
    z-index: 9999;
    opacity: 0;
    transition: opacity 0.5s ease;
    max-width: 80%;
    text-align: center;
      ">
        🌟 ¡Tu momento ha sido compartido con el alma!
      </div>

      <!-- El contenido sigue aquí 👇 -->
    <section id="uploadFormContainer" class="upload-form-container" aria-hidden="true">
      

  


  <form id="uploadForm" enctype="multipart/form-data" method="post">

    <!-- 🌅 Imagen emocional primero -->
    <input type="file" id="image" name="image" accept="image/*" required />

    <div id="imagePreviewContainer" style="margin-top: 1rem; display:none;">
      <img id="imagePreview" src="" alt="Vista previa" style="max-width: 100%; border-radius: 8px;" />
    </div>

    <!-- 📝 Descripción emocional -->
    <input type="text" name="description" id="description"
       placeholder="Pon algo raro, triste o chistoso. Da igual, es tuyo." required />



    <!-- 🔮 Sección o categoría emocional -->
    <div id="section-buttons" style="margin-top: 1rem; margin-bottom: 1rem;">
      <span class="section-button" data-value="caos_bonito">❤️‍🔥 Caos bonito</span>
      <span class="section-button" data-value="zona_cero">👾 Zona cer0</span>
      <span class="section-button" data-value="404_emocional">😶‍🌫️ 404 Emocional</span>
      <span class="section-button" data-value="nunca_antes_visto">👻 Nunca antes visto</span>
    </div>

    <input type="hidden" name="section" id="selected-section" required>

    <!-- 🔐 Visibilidad -->
    <div style="margin-top: 1rem;">
  <label for="visibility" style="display:block; margin-bottom: 0.25rem;">¿Quién puede ver esto?</label>
  <select name="visibility" id="visibility">
    <option value="public">🌍 Que lo vea el mundo</option>
    <option value="private">🕶️ Solo yo (modo ninja)</option>
    <option value="patch">🫂 Solo mi parche</option>
  </select>
</div>


    <!-- ⏳ Duración emocional -->
    <div style="margin-top: 1rem;">
  <label for="duration" style="display:block; margin-bottom: 0.25rem;">¿Por cuánto tiempo se quedará vivo?</label>
  <select name="duration" id="duration" required>
    <option value="">⏳ Elige su destino...</option>
    <option value="30">💨 30 minutos (pasa volando)</option>
    <option value="60">🕐 1 hora (breve pero intenso)</option>
    <option value="180">🔥 3 horas (alto voltaje)</option>
    <option value="360">🌅 6 horas (como un atardecer largo)</option>
  </select>
</div>

    <!-- Después -->
<div id="patchSelectorContainer" style="display: none;">

</div>
  
    <!-- ✨ Botón emocional -->
    <button type="submit" style="margin-top: 1.5rem;">Que vuele</button>
  </form>
</section>
      
<div class="sidebar-buttons">
  <button id="exploreBtn" class="sidebar-btn" aria-label="Explorar emociones">✨</button>
  <div class="tooltip-container">
  <button id="toggleUploadBtn" class="sidebar-btn" aria-label="Subir imagen">
  <img src="assets/icons/image-up.png" alt="Subir imagen" width="24" height="24">
</button>
  <div class="tooltip-text">
    📸 Sube algo que solo tú entiendas.<br>No tiene que tener sentido.<br>Solo que diga algo.<br>Aunque sea sin decirlo.
  </div>
</div>
  <button id="menuToggleBtn" class="sidebar-btn" aria-label="Abrir menú">
  <img src="assets/icons/menu.png" alt="Menú" width="24" height="24">
</button>
<div class="tooltip-container">
  <a href="circles.html" class="sidebar-btn" aria-label="Gestionar parches">
  <img src="/assets/icons/patch-icon.png" alt="Parches" style="width: 1.6rem; height: 1.6rem;" />
</a>
  <div class="tooltip-text">👥 Gestiona tus parches y alianzas.</div>
</div>


  
  <!-- Contenedor relativo para el botón y su dropdown -->
  <div id="notificationsContainer" style="position: relative;">
    <button id="notifBtn" class="sidebar-btn" aria-label="Ver notificaciones">
  <img src="assets/icons/bell.png" alt="Notificaciones" width="24" height="24">
  <span id="notifCount">0</span>
</button>


    <!-- 🔽 Dropdown va aquí mismo -->
    <div id="notifDropdown">
      <ul id="notifList" style="list-style:none;padding:0.5rem;margin:0;"></ul>
    </div>
  </div>
</div>

<!-- Modal para gestión de parches -->
<section id="patchManager" class="upload-form-container" aria-hidden="true" style="max-width: 400px;">
  <h2 style="color: var(--btn-text); margin-bottom: 1rem;">Crear nuevo parche</h2>
  
  <form id="createPatchForm">
    <input type="text" id="patchName" placeholder="Nombre del parche" required style="margin-bottom:1rem;"/>
    <button type="submit">Crear parche</button>
  </form>

  <div id="patchMessage" style="margin-top: 1rem; min-height: 1.4rem;"></div>

  <hr style="margin: 1.5rem 0; border-color: var(--notif-border);" />

  <h3 style="color: var(--btn-text); margin-bottom: 0.5rem;">Buscar usuarios para invitar</h3>
  <input type="text" id="userSearch" placeholder="Busca usuarios por nombre o email" style="margin-bottom: 0.75rem;"/>

  <ul id="searchResults" style="list-style:none; padding-left:0; color: var(--btn-text); max-height: 180px; overflow-y: auto;"></ul>

  <button id="closePatchManagerBtn" style="margin-top: 1rem; background-color: var(--btn-hover); color: var(--btn-text); border: none; border-radius: 6px; padding: 0.6rem 1rem; cursor: pointer;">
    Cerrar
  </button>
</section>

      <main id="timeline" role="main" tabindex="0">
        <div id="imagesContainer" class="images-grid" aria-live="polite"></div>
      </main>
    </div>
  </div>

    </div>
  </div>
</footer>

    <div id="menuOverlay" class="menu-overlay" aria-hidden="true">
      <!-- Dentro de .menu-content -->
     <button id="closeMenuBtn" class="close-menu-btn" aria-label="Cerrar menú">
  <img src="assets/icons/x.png" alt="Cerrar" width="24" height="24">
</button>


      
  <div class="menu-content">
    <button id="logoutMenuBtn" class="footer-link"> Cerrar sesión</button>
    <a href="#" id="soulprintMenuBtn" class="footer-link"> Mi Soulprint</a>
  </div>
</div>

  <!-- Aquí, antes de cerrar body -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const menuToggleBtn = document.getElementById('menuToggleBtn');
      const menuOverlay   = document.getElementById('menuOverlay');
      
      menuToggleBtn.addEventListener('click', () => {
        // Solo toggle de 'show'
        const isVisible = menuOverlay.classList.toggle('show');
        menuOverlay.setAttribute('aria-hidden', (!isVisible).toString());
      });
      
      const closeMenuBtn = document.getElementById('closeMenuBtn');
closeMenuBtn.addEventListener('click', () => {
  menuOverlay.classList.remove('show');
  menuOverlay.setAttribute('aria-hidden', 'true');
  document.body.classList.remove('menu-open');
});

     /* ——— Lógica para “Mi Soulprint” ——— */
  const soulprintMenuBtn = document.getElementById('soulprintMenuBtn');
  let userObj = null;
  try {
    userObj = JSON.parse(localStorage.getItem('user'));
  } catch {}
  if (userObj && userObj.username) {
    // Si estás logueado, apuntamos al soulprint de tu usuario
    soulprintMenuBtn.setAttribute(
      'href',
      `soulprint.html?user=${encodeURIComponent(userObj.username)}`
    );
  } else {
    // Si NO, mostramos alerta y vamos al login al click
    soulprintMenuBtn.addEventListener('click', e => {
      e.preventDefault();
      alert('Debes iniciar sesión para ver tu Soulprint');
      window.location.href = 'index.html';
    });
  }

  /* ——— (opcional) listener de Cerrar sesión ——— */
  const logoutMenuBtn = document.getElementById('logoutMenuBtn');
  logoutMenuBtn.addEventListener('click', () => {
    localStorage.clear();
    window.location.href = 'index.html';
  });
// ✅ Lucide icons
    lucide.createIcons();
  });
  </script>
  <script src="https://unpkg.com/lucide@latest"></script>
<script>
  lucide.createIcons();
</script>
</body>
</html>

  <script>
document.addEventListener('DOMContentLoaded', () => {
  const toggleBtn         = document.getElementById('toggleUploadBtn');
  const uploadForm        = document.getElementById('uploadFormContainer');
  const logoutBtn         = document.getElementById('logoutBtn');
  const soulprintBtn      = document.getElementById('soulprintBtn');
  const logoutMenuBtn     = document.getElementById('logoutMenuBtn');
  const soulprintMenuBtn  = document.getElementById('soulprintMenuBtn');
  const menuToggleBtn     = document.getElementById('menuToggleBtn');
  const menuOverlay       = document.getElementById('menuOverlay');
  const darkToggle        = document.getElementById('darkModeToggle');
  const body              = document.body;
  const token             = localStorage.getItem('token');
  const buttons           = document.querySelectorAll('.section-button');
  const hiddenInput       = document.getElementById('selected-section');
  const form              = document.getElementById('uploadForm');
  // 1️⃣ Obtén los elementos correctos
const visibilitySelect = document.getElementById('visibility');
const patchSelectorContainer = document.getElementById('patchSelectorContainer');

visibilitySelect.addEventListener('change', async () => {
  const isPatch = visibilitySelect.value === 'patch';

  // Mostrar u ocultar secciones
  const sectionButtons = document.getElementById('section-buttons');
  const sectionInput = document.getElementById('selected-section');

  if (isPatch) {
    sectionButtons.style.display = 'none';
    sectionInput.value = ''; // Limpiar valor seleccionado
  } else {
    sectionButtons.style.display = 'block';
  }

  // Mostrar u ocultar selector de parches
  patchSelectorContainer.style.display = isPatch ? 'block' : 'none';
  patchSelectorContainer.innerHTML = isPatch
    ? `<p style="margin-bottom: 0.5rem;">Selecciona los parches con los que quieres compartir:</p>`
    : '';

  if (!isPatch) return;

  try {
    const res = await fetch(`${API_URL}/api/patches`, {
      headers: { Authorization: `Bearer ${token}` }
    });
    const patches = await res.json();

    if (!Array.isArray(patches)) throw new Error('No se recibieron parches válidos');

    patches.forEach(patch => {
      const label = document.createElement('label');
      label.style.display = 'block';
      label.style.marginBottom = '0.25rem';

      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.name = 'patches';
      checkbox.value = patch._id;

      label.appendChild(checkbox);
      label.appendChild(document.createTextNode(' ' + patch.name));
      patchSelectorContainer.appendChild(label);
    });

  } catch (err) {
    console.error('Error al cargar parches:', err);
    patchSelectorContainer.innerHTML = '<p style="color:red;">Error al cargar parches.</p>';
  }
});


const sectionButtons = document.getElementById('section-buttons');
const sectionInput = document.getElementById('selected-section');

  // 🔹 Secciones
  buttons.forEach(button => {
    button.addEventListener('click', () => {
      buttons.forEach(btn => btn.classList.remove('selected'));
      button.classList.add('selected');
      hiddenInput.value = button.dataset.value;
      console.log('✅ Sección seleccionada:', hiddenInput.value);
    });
  });

async function cargarImagenesFiltradas(seccion = 'all') {
  const token = localStorage.getItem('token');

  try {
    const res = await fetch('https://momento-backend-production.up.railway.app/api/images', {
      headers: {
        Authorization: `Bearer ${token}`
      }
    });

    if (!res.ok) throw new Error('Error al obtener imágenes');

    const todasLasImagenes = await res.json();

    const filtradas = seccion === 'all'
      ? todasLasImagenes
      : todasLasImagenes.filter(img => img.section === seccion);

    renderImages(filtradas);
  } catch (err) {
    console.error('Error al cargar imágenes:', err);
  }
}

  
  // ✅ Cargar usuario desde localStorage
  let username = null;
  try {
    const storedUser = JSON.parse(localStorage.getItem('user'));
    if (storedUser) {
      username = storedUser.username;
    }
  } catch (e) {
    console.error('Error leyendo localStorage', e);
  }

  // ✅ Soulprint desde botón principal
  if (username) {
    soulprintBtn.href = `soulprint.html?user=${encodeURIComponent(username)}`;
    soulprintMenuBtn.href = `soulprint.html?user=${encodeURIComponent(username)}`;
  } else {
    const redirectToLogin = (e) => {
      e.preventDefault();
      alert('Debes iniciar sesión para ver tu Soulprint');
      window.location.href = 'index.html';
    };
    soulprintBtn.addEventListener('click', redirectToLogin);
    soulprintMenuBtn.addEventListener('click', redirectToLogin);
  }

  // ✅ Animación Soulprint
  soulprintBtn.classList.add('animate');
  setTimeout(() => soulprintBtn.classList.remove('animate'), 800);
  soulprintBtn.addEventListener('click', () => {
    soulprintBtn.classList.add('animate');
    setTimeout(() => soulprintBtn.classList.remove('animate'), 800);
  });

  // ✅ Mostrar/ocultar formulario
  toggleBtn.addEventListener('click', () => {
    const isVisible = uploadForm.classList.toggle('visible');
    uploadForm.setAttribute('aria-hidden', (!isVisible).toString());
  });


  // ✅ Cerrar sesión
  logoutBtn.addEventListener('click', () => {
    localStorage.clear();
    window.location.href = 'index.html';
  });
  logoutMenuBtn.addEventListener('click', () => {
    localStorage.clear();
    window.location.href = 'index.html';
  });

const filtros = document.querySelectorAll('.filter-btn');
filtros.forEach(btn => {
  btn.addEventListener('click', () => {
    filtros.forEach(b => b.classList.remove('selected'));
    btn.classList.add('selected');
    const filtro = btn.dataset.filter || 'all';
    cargarImagenesFiltradas(filtro);
  });
});

  // ✨ Explorar emociones - Botón flotante y panel
const exploreBtn = document.getElementById('exploreBtn');
const emotionPanel = document.getElementById('emotionPanel');
const closeEmotionPanel = document.getElementById('closeEmotionPanel');
  // 🫂 Botón para ir a circles.html
const openPatchManagerBtn = document.getElementById('openPatchManagerBtn');
openPatchManagerBtn?.addEventListener('click', () => {
  window.location.href = 'circles.html';
});


// Mostrar el panel
exploreBtn?.addEventListener('click', () => {
  emotionPanel.style.display = 'flex';
  emotionPanel.setAttribute('aria-hidden', 'false');
});

// Cerrar el panel
closeEmotionPanel?.addEventListener('click', () => {
  emotionPanel.style.display = 'none';
  emotionPanel.setAttribute('aria-hidden', 'true');
});

// Manejar clics en los filtros emocionales
document.querySelectorAll('.emotion-filter').forEach(btn => {
  btn.addEventListener('click', () => {
    const filtro = btn.getAttribute('data-filter') || 'all';
    cargarImagenesFiltradas(filtro);
    emotionPanel.style.display = 'none';
  });
});
    });
  </script>
  <script src="js/upload.js"></script>
</body>
</html>
