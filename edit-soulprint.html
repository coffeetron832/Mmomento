<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Editar Soulprint</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600&family=DM+Serif+Display&display=swap');
    *, *::before, *::after { box-sizing: border-box; margin:0; padding:0; }
    body { display:flex; min-height:100vh; margin:0; font-family:'Quicksand',sans-serif; background:linear-gradient(to right,#f9f9f9,#e8ecf0); }
    .form-container { width:50%; padding:2rem; }
    .preview-container { width:50%; display:flex; align-items:center; justify-content:center; padding:2rem; background:linear-gradient(135deg,#fff,#f0f4ff); }
    form { display:flex; flex-direction:column; gap:1.2rem; }
    label { font-weight:bold; }
    input, select, textarea { padding:0.6rem; border:1px solid #ccc; border-radius:0.5rem; font-size:1rem; width:100%; }
    .preview-card { position:relative; max-width:340px; width:100%; background:#fff; border-radius:2rem; box-shadow:0 8px 24px rgba(0,0,0,0.1); text-align:center; padding:2rem; }
    .halo { position:absolute; top:-20px; left:-20px; right:-20px; bottom:-20px; background:var(--soul-color,#aaa); filter:blur(40px); border-radius:2rem; opacity:0.5; }
    .profile-img { width:100px; height:100px; border-radius:50%; object-fit:cover; border:4px solid #fff; margin-top:-80px; background:#ccc; }
    .emoji-choice { width:40px; height:40px; display:none; margin-left:12px; }
    .username { font-family:'DM Serif Display',serif; font-size:1.5rem; margin-top:1rem; }
    .birthdate-display, .phrase, #previewRole { margin-bottom:1rem; }
    .phrase { font-style:italic; }
    .moment-img { width:100%; max-height:200px; object-fit:cover; border-radius:1rem; margin-top:1rem; }
    #responseMessage { margin-top:1rem; font-weight:bold; }
    #emoji-wrapper { display:flex; align-items:center; gap:8px; }
    #emoji-selector { display:flex; overflow-x:auto; gap:4px; max-width:220px; padding:5px 0; }
    #emoji-selector img { width:30px; height:30px; opacity:0.6; cursor:pointer; border-radius:50%; border:2px solid transparent; transition:border-color .2s, opacity .2s; }
    #emoji-selector img.selected { opacity:1; border-color:#4f46e5; }
    #scrollLeft, #scrollRight { background:none; border:none; font-size:1.2rem; cursor:pointer; }
  </style>
</head>
<body>
  <div class="form-container">
    <h2>Editar tu Soulprint</h2>
    <form id="soulprintForm" enctype="multipart/form-data">
      <label for="soulPhrase">Frase del alma:</label>
      <textarea id="soulPhrase" name="soulPhrase" maxlength="100" required></textarea>

      <label for="soulColor">Color del alma:</label>
      <input type="color" id="soulColor" name="soulColor" />

      <label for="birthdate">Mi primer latido:</label>
      <input type="date" id="birthdate" name="birthdate" required />

      <label for="soulRole">Rol del alma:</label>
      <select id="soulRole" name="soulRole" required>
        <option value="">Selecciona uno</option>
        <option value="üíñ Arquitecto/a de Emociones">üíñ Arquitecto/a de Emociones</option>
        <option value="üõπ Alma Callejera">üõπ Alma Callejera</option>
        <option value="üöÄ Coraz√≥n N√≥mada">üöÄ Coraz√≥n N√≥mada</option>
        <option value="üß¢ Rompe-esquemas">üß¢ Rompe-esquemas</option>
      </select>

      <label>Emoji del alma:</label>
      <div id="emoji-wrapper">
        <button type="button" id="scrollLeft">‚Üê</button>
        <div id="emoji-selector"></div>
        <input type="hidden" id="emojiURL" name="emojiURL" />
        <button type="button" id="scrollRight">‚Üí</button>
      </div>

      <label for="profileImageInput">Foto de perfil:</label>
      <input type="file" id="profileImageInput" name="profileImage" accept="image/*" />

      <label for="pinnedMoment">Momento anclado:</label>
      <select id="pinnedMoment" name="pinnedMoment"></select>

      <button type="submit">Guardar cambios</button>
      <div id="responseMessage"></div>
    </form>
  </div>

  <div class="preview-container">
    <div class="preview-card">
      <div class="halo" id="haloPreview"></div>
      <div style="display:flex; align-items:center; gap:12px;">
        <img id="previewProfileImage" class="profile-img" src="/default-avatar.png" alt="Foto previa" />
        <img id="previewEmoji" class="emoji-choice" alt="Emoji previo" />
      </div>
      <div class="username" id="previewUsername"></div>
      <div class="birthdate-display">Mi primer latido: <span id="previewBirthdate"></span></div>
      <div class="phrase" id="previewPhrase"></div>
      <div id="previewRole"></div>
      <img id="previewMoment" class="moment-img" style="display:none;" alt="Momento previo" />
    </div>
  </div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const username = params.get('user');
    const token = localStorage.getItem('token');

    const form = document.getElementById('soulprintForm');
    const fields = ['soulPhrase','soulColor','birthdate','soulRole'];
    const els = Object.fromEntries(fields.map(id => [id, document.getElementById(id)]));

    const emojiSelector = document.getElementById('emoji-selector');
    const emojiURL = document.getElementById('emojiURL');

    const prUser = document.getElementById('previewUsername');
    const prPhrase = document.getElementById('previewPhrase');
    const prHalo = document.getElementById('haloPreview');
    const prImg = document.getElementById('previewProfileImage');
    const prDate = document.getElementById('previewBirthdate');
    const prRole = document.getElementById('previewRole');
    const prMoment = document.getElementById('previewMoment');
    const prEmoji = document.getElementById('previewEmoji');

    prUser.innerText = '@' + username;

    function initEmojis(selected) {
      emojiSelector.innerHTML = '';
      for (let i = 1; i <= 15; i++) {
        const url = `/emoji${i}.png`;
        const img = new Image(30,30);
        img.src = url;
        img.alt = `emoji${i}`;
        img.classList.toggle('selected', url === selected);
        img.onclick = () => {
          emojiSelector.querySelectorAll('img').forEach(e => e.classList.remove('selected'));
          img.classList.add('selected');
          emojiURL.value = url;
          prEmoji.src = url;
          prEmoji.style.display = 'inline-block';
        };
        emojiSelector.appendChild(img);
      }
    }

    async function load() {
      const res = await fetch(`/api/users/soulprint/${encodeURIComponent(username)}`, {
        headers: { Authorization: 'Bearer ' + token }
      });
      const { soulprint } = await res.json();

      els.soulPhrase.value = soulprint.soulPhrase || '';
      els.soulColor.value = soulprint.soulColor || '#88c0d0';
      els.birthdate.value = soulprint.birthdate || '';
      els.soulRole.value = soulprint.soulRole || '';

      initEmojis(soulprint.emojiURL || '');
      if (soulprint.emojiURL) {
        prEmoji.src = soulprint.emojiURL;
        prEmoji.style.display = 'inline-block';
        emojiURL.value = soulprint.emojiURL;
      }

      prPhrase.innerText = soulprint.soulPhrase || '';
      prHalo.style.setProperty('--soul-color', soulprint.soulColor || '#88c0d0');
      prImg.src = soulprint.profileImage || '/default-avatar.png';
      prDate.innerText = soulprint.birthdate
        ? new Date(soulprint.birthdate).toLocaleDateString('es-ES',{year:'numeric',month:'long',day:'numeric'})
        : '';
      prRole.innerText = soulprint.soulRole || '';

      const mres = await fetch(`/api/users/${encodeURIComponent(username)}/moments`, {
        headers: { Authorization: 'Bearer ' + token }
      });
      const moments = await mres.json();
      const sel = document.getElementById('pinnedMoment');
      sel.innerHTML = '';
      moments.forEach(m => {
        const o = new Option(`Momento #${m._id.slice(-4)}`, m._id);
        o.dataset.url = m.imageUrl;
        sel.add(o);
      });
      if (soulprint.pinnedMoment) {
        sel.value = soulprint.pinnedMoment._id;
        prMoment.src = soulprint.pinnedMoment.imageUrl;
        prMoment.style.display = 'block';
      }
    }

    fields.forEach(f => els[f].addEventListener('input', e => {
      switch(f) {
        case 'birthdate':
          prDate.innerText = e.target.value
            ? new Date(e.target.value).toLocaleDateString('es-ES',{year:'numeric',month:'long',day:'numeric'})
            : '';
          break;
        case 'soulPhrase': prPhrase.innerText = e.target.value; break;
        case 'soulColor': prHalo.style.setProperty('--soul-color', e.target.value); break;
        case 'soulRole': prRole.innerText = e.target.value; break;
      }
    }));

    document.getElementById('scrollLeft').onclick = () => emojiSelector.scrollBy({ left:-80,behavior:'smooth' });
    document.getElementById('scrollRight').onclick = () => emojiSelector.scrollBy({ left:80,behavior:'smooth' });

    form.onsubmit = async e => {
      e.preventDefault();
      const fd = new FormData(form);
      fd.append('emojiURL', emojiURL.value);
      const r = await fetch(`/api/users/soulprint/${encodeURIComponent(username)}`, {
        method: 'PUT',
        headers: { Authorization: 'Bearer ' + token },
        body: fd
      });
      const msg = document.getElementById('responseMessage');
      if (r.ok) {
        msg.textContent = '‚úÖ Soulprint actualizado'; msg.style.color = 'green';
        await load();
      } else {
        const b = await r.json();
        msg.textContent = '‚ùå ' + b.message; msg.style.color = 'crimson';
      }
    };

    load();
  </script>
</body>
</html>

