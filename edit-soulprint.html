<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Editar Soulprint</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600&family=DM+Serif+Display&display=swap');
    body { margin:0; font-family:'Quicksand',sans-serif; background:linear-gradient(to right,#f9f9f9,#e8ecf0); display:flex; min-height:100vh; }
    .form-container { width:50%; padding:2rem; box-sizing:border-box; }
    .preview-container { width:50%; display:flex; align-items:center; justify-content:center; padding:2rem; background:linear-gradient(135deg,#fff,#f0f4ff); }
    form { display:flex; flex-direction:column; gap:1.2rem; }
    label { font-weight:bold; }
    input, select, textarea { padding:0.6rem; border:1px solid #ccc; border-radius:0.5rem; font-size:1rem; width:100%; box-sizing:border-box; }
    .preview-card { position:relative; max-width:340px; width:100%; background:#fff; border-radius:2rem; box-shadow:0 8px 24px rgba(0,0,0,0.1); text-align:center; padding:2rem; }
    .halo { position:absolute; top:-20px; left:-20px; right:-20px; bottom:-20px; background:var(--soul-color,#aaa); filter:blur(40px); border-radius:2rem; opacity:0.5; }
    .profile-img { width:100px; height:100px; border-radius:50%; object-fit:cover; border:4px solid #fff; margin-top:-80px; background:#ccc; }
    .emoji-choice { width:30px !important; height:30px !important; margin-left:10px; display:none; }
    .username { font-family:'DM Serif Display',serif; font-size:1.5rem; margin-top:1rem; color:#333; }
    .birthdate-display{font-size:0.9rem;color:#555;margin-bottom:1rem;}
    .phrase{font-style:italic;color:#666;margin:0.5rem 0 1rem;}
    .moment-img{width:100%;max-height:200px;object-fit:cover;border-radius:1rem;margin-top:1rem;box-shadow:0 0 8px rgba(0,0,0,0.08);}
    #responseMessage{margin-top:1rem;font-weight:bold;}
    #emoji-wrapper{display:flex;align-items:center;gap:8px;}
    #emoji-selector{overflow-x:auto;white-space:nowrap;scroll-behavior:smooth;max-width:220px;padding:5px 0;display:flex;gap:8px;}
    #emoji-selector img{width:30px;height:30px;opacity:0.6;cursor:pointer;border-radius:50%;border:2px solid transparent;transition:border-color .2s,opacity .2s;}
    #emoji-selector img.selected{border-color:#4f46e5;opacity:1;}
    #scrollLeft,#scrollRight{background:none;border:none;font-size:1.2rem;cursor:pointer;}
  </style>
</head>
<body>
  <div class="form-container">
    <h2>Editar tu Soulprint</h2>
    <form id="soulprintForm" enctype="multipart/form-data">
      <label for="soulPhrase">Frase del alma:</label>
      <textarea id="soulPhrase" name="soulPhrase" maxlength="100" required></textarea>

      <label for="soulColor">Color del alma:</label>
      <input type="color" id="soulColor" name="soulColor" />

      <label for="birthdate">Mi primer latido:</label>
      <input type="date" id="birthdate" name="birthdate" required />

      <label for="soulRole">Rol del alma:</label>
      <select id="soulRole" name="soulRole" required>
        <option value="">Selecciona uno</option>
        <option value="üíñ Arquitecto/a de Emociones">üíñ Arquitecto/a de Emociones</option>
        <option value="üöù Alma Callejera">üöù Alma Callejera</option>
        <option value="üöÄ Coraz√≥n N√≥mada">üöÄ Coraz√≥n N√≥mada</option>
        <option value="üßë‚Äçüéì Rompe-esquemas">üßë‚Äçüéì Rompe-esquemas</option>
      </select>

      <label>Elige tu emoji del alma:</label>
      <div id="emoji-wrapper">
        <button type="button" id="scrollLeft">‚Üê</button>
        <div id="emoji-selector"></div>
        <input type="hidden" id="emojiURL" name="emojiURL" />
        <button type="button" id="scrollRight">‚Üí</button>
      </div>

      <label for="profileImageInput">Foto de perfil:</label>
      <input type="file" id="profileImageInput" name="profileImage" accept="image/*" />

      <label for="pinnedMoment">Momento anclado:</label>
      <select id="pinnedMoment" name="pinnedMoment"></select>

      <button type="submit">Guardar cambios</button>
      <div id="responseMessage"></div>
    </form>
  </div>

  <div class="preview-container">
    <div class="preview-card">
      <div class="halo" id="haloPreview"></div>
      <div style="display:flex;align-items:center;gap:12px;">
        <img id="previewProfileImage" class="profile-img" src="/default-avatar.png" alt="Foto previa" />
        <img id="previewEmoji" class="emoji-choice" alt="Emoji previo" />
      </div>
      <div class="username" id="previewUsername"></div>
      <div class="birthdate-display">Mi primer latido: <span id="previewBirthdate"></span></div>
      <div class="phrase" id="previewPhrase"></div>
      <div id="previewRole" style="font-weight:bold;color:#444;margin-top:0.5rem;"></div>
      <img id="previewMoment" class="moment-img" style="display:none;" alt="Momento previo" />
    </div>
  </div>

  <script>
    const username = new URLSearchParams(location.search).get('user');
    const token = localStorage.getItem('token');

    const form = document.getElementById('soulprintForm');
    const emojiSelector = document.getElementById('emoji-selector');
    const emojiURLInput = document.getElementById('emojiURL');
    const previewEmoji = document.getElementById('previewEmoji');
    const previewUsername = document.getElementById('previewUsername');
    previewUsername.innerText = '@' + username;

    function initEmojiSelector(selectedUrl) {
      emojiSelector.innerHTML = '';
      for (let i = 1; i <= 15; i++) {
        const url = `/emoji${i}.png`;
        const img = document.createElement('img');
        img.src = url;
        img.alt = `emoji${i}`;
        img.onclick = () => {
          document.querySelectorAll('#emoji-selector img').forEach(e => e.classList.remove('selected'));
          img.classList.add('selected');
          emojiURLInput.value = url;
          previewEmoji.src = url;
          previewEmoji.style.display = 'inline-block';
        };
        if (url === selectedUrl) {
          img.classList.add('selected');
          emojiURLInput.value = url;
          previewEmoji.src = url;
          previewEmoji.style.display = 'inline-block';
        }
        emojiSelector.append(img);
      }
    }

    document.getElementById('scrollLeft').onclick = () => emojiSelector.scrollBy({ left: -80, behavior: 'smooth' });
    document.getElementById('scrollRight').onclick = () => emojiSelector.scrollBy({ left: 80, behavior: 'smooth' });

    async function loadSoulprint() {
      const res = await fetch(`https://momento-backend-production.up.railway.app/api/users/soulprint/${encodeURIComponent(username)}`, {
        headers: { Authorization: 'Bearer ' + token }
      });
      const { soulprint } = await res.json();
      document.getElementById('soulPhrase').value = soulprint.soulPhrase || '';
      document.getElementById('soulColor').value = soulprint.soulColor || '#88c0d0';
      document.getElementById('birthdate').value = soulprint.birthdate || '';
      document.getElementById('soulRole').value = soulprint.soulRole || '';
      initEmojiSelector(soulprint.emojiURL || '');
      document.getElementById('previewPhrase').innerText = soulprint.soulPhrase || '';
      document.getElementById('haloPreview').style.setProperty('--soul-color', soulprint.soulColor || '#88c0d0');
      document.getElementById('previewProfileImage').src = soulprint.profileImage || '/default-avatar.png';
      document.getElementById('previewBirthdate').innerText = soulprint.birthdate ? new Date(soulprint.birthdate).toLocaleDateString('es-ES') : '';
      document.getElementById('previewRole').innerText = soulprint.soulRole || '';
      if (soulprint.emojiURL) {
        document.getElementById('previewEmoji').src = soulprint.emojiURL;
        document.getElementById('previewEmoji').style.display = 'inline-block';
      }
    }

    form.onsubmit = async (e) => {
      e.preventDefault();
      const fd = new FormData(form);
      const file = document.getElementById('profileImageInput').files[0];
      if (file) fd.append('profileImage', file);
      const res = await fetch(`https://momento-backend-production.up.railway.app/api/users/soulprint/${encodeURIComponent(username)}`, {
        method: 'PUT',
        headers: { Authorization: 'Bearer ' + token },
        body: fd
      });
      const msg = document.getElementById('responseMessage');
      if (res.ok) {
        msg.textContent = '‚úÖ Soulprint actualizado';
        msg.style.color = 'green';
        await loadSoulprint();
      } else {
        const err = await res.json();
        msg.textContent = '‚ùå ' + err.message;
        msg.style.color = 'crimson';
      }
    };

    loadSoulprint();
  </script>
</body>
</html>

